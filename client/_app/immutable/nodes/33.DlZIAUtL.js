import{f as l,a,c as at,t as rt}from"../chunks/DKNWTM-D.js";import{w as T,g as wt,o as Ct,a as At}from"../chunks/DpyMT7OB.js";import{p as Rt,d as et,e as Tt,f as N,a as kt,t as g,s as j,b as B,$ as Pt,n as z,g as w,c as n,r as i}from"../chunks/KPVYLOSR.js";import{d as Ut,h as Vt,s as C}from"../chunks/NtGCh5xy.js";import{a as Ft}from"../chunks/DXJ436YI.js";import{i as _}from"../chunks/CDCmQmr-.js";import{s as qt,r as Dt}from"../chunks/Be_LeCLl.js";import{a as Nt}from"../chunks/BlQKM0Gb.js";import{s as St,a as Q}from"../chunks/B2Bg6RTa.js";import{g as Lt}from"../chunks/DNfOBMJV.js";import{E as R,s as A,b as It}from"../chunks/BD7x6Jnt.js";import{t as ot}from"../chunks/CWjZNTTC.js";import{C as Ot}from"../chunks/a16e0A8-.js";import{E as st}from"../chunks/P3bGLiu7.js";import{S as Gt}from"../chunks/C92RFBuR.js";import{c as it}from"../chunks/BpV1Tt4c.js";import{g as jt}from"../chunks/BibUdOWF.js";import{L as Bt}from"../chunks/BW_ShK1N.js";const lt="/picsure/query/sync",ct=T(0),dt=T([]),vt=T([]),ut=T(""),pt=T(R.Aggregate),H=T("");async function Qt(c){c.query.expectedResultType="VARIANT_COUNT_FOR_QUERY";const d=await it(lt,c).then(e=>e.count).catch(e=>(console.error(e),H.set("An error occured while retrieving variant count data. Please contact your PIC-SURE admin."),0));ct.set(d)}async function nt(c){c.query.expectedResultType=wt(pt)===R.Aggregate?"AGGREGATE_VCF_EXCERPT":"VCF_EXCERPT";const d=await it(lt,c).catch(t=>(console.error(t),H.set("An error occured while retrieving variant data. Please contact your PIC-SURE admin."),""));if(!d)return;ut.set(URL.createObjectURL(new Blob([d],{type:"octet/stream"})));const e=d.split(`
`),k=e[0].split("	"),r=e.slice(1).map(t=>t.split("	")).filter(t=>t.length>1),P=A.variantExplorer.excludeColumns.map(t=>k.indexOf(t)).filter(t=>t>=0);vt.set(r.map(t=>t.reduce((v,U,x)=>(P.includes(x)||(v[k[x].toString()]=U),v),{}))),dt.set(k.filter((t,v)=>!P.includes(v)).map(t=>({dataElement:t,label:t,sort:!0})))}var Xt=l('<div><a data-testid="variant-download-btn" class="btn preset-tonal-primary border border-primary-500 mt-8 mr-6 float-right" download="variantData.tsv"> </a></div>'),Yt=l('<div data-testid="variant-count"><p> </p></div>'),Mt=l('<div><label class="flex items-center space-x-2"><input class="checkbox" type="checkbox"/> <p>Aggregate data</p></label></div>'),Wt=l('<div class="flex-auto flex items-end justify-between"><!> <!></div>'),zt=l('<div data-testid="variant-count" class="flex-none w-full"> </div>'),Ht=l('<div data-testid="variant-count" class="flex-none w-full"> </div>'),Jt=l("<!> <!>",1),Kt=l('<h2 class="text-center clear-both">Variant Explorer</h2> <!>',1),Zt=l("<!> <!>",1);function xa(c,d){Rt(d,!0);const[e,k]=St(),r=()=>Q(ct,"$count",e),P=()=>Q(ut,"$downloadUrl",e),t=()=>Q(vt,"$data",e),v=()=>Q(dt,"$columns",e);let U=et(Tt(Promise.resolve())),x,b=et(A.variantExplorer.type===R.Full),V;async function mt(){await Qt(V),r()>0&&r()<=A.variantExplorer.maxCount&&await nt(V)}async function ft(){B(b,!w(b)),pt.set(w(b)?R.Aggregate:R.Full),B(U,nt(V),!0)}Ct(()=>{V=jt(!0),V.query.hasFilter()?(x=H.subscribe(s=>{s&&ot.error({title:s})}),B(U,mt(),!0)):(ot.error({title:"No query provided. Please add a genomic filter to explore variant data."}),Lt("/explorer"))}),At(()=>{x&&x()});var J=Zt();Vt(s=>{g(()=>Pt.title=`${It.applicationName??""} | Variant Explorer`)});var K=N(J);{var gt=s=>{var S=Xt(),$=n(S),X=n($);i($),i(S),g(()=>{qt($,"href",P()),C(X,`Download Variant${w(b)?" (Aggregate)":""} Data`)}),a(s,S)};_(K,s=>{P()&&s(gt)})}var _t=j(K,2);Ot(_t,{full:!0,backUrl:"/explorer",backTitle:"Back to Explore",children:(s,S)=>{var $=at(),X=N($);{var xt=Y=>{var Z=Kt(),bt=j(N(Z),2);Ft(bt,()=>w(U),F=>{var u=Jt(),h=N(u);{var L=o=>{var p=Ht(),I=n(p);i(p),g(()=>C(I,`${r()??""} variants found`)),a(o,p)};_(h,o=>{r()>0&&o(L)})}var y=j(h,2);Bt(y,{}),a(F,u)},F=>{var u=at(),h=N(u);{var L=o=>{st(o,{color:"warning",children:(p,I)=>{z();var O=rt();g(()=>C(O,`Too many variants! Found ${r()??""}, but cannot display more than
          ${A.variantExplorer.maxCount??""} variants.`)),a(p,O)},$$slots:{default:!0}})},y=(o,p)=>{{var I=E=>{Gt(E,{tableName:"variant-explorer",get data(){return t()},get columns(){return v()},fullWidth:!0,searchable:!0,tableActions:M=>{var W=Wt(),tt=n(W);{var $t=m=>{var f=Yt(),q=n(f),D=n(q);i(q),i(f),g(()=>C(D,`${r()??""} variants found`)),a(m,f)};_(tt,m=>{r()>0&&m($t)})}var ht=j(tt,2);{var yt=m=>{var f=Mt(),q=n(f),D=n(q);Dt(D),D.__click=ft,z(2),i(q),i(f),Nt(D,()=>w(b),Et=>B(b,Et)),a(m,f)};_(ht,m=>{A.variantExplorer.type===R.Full&&m(yt)})}i(W),a(M,W)},$$slots:{tableActions:!0}})},O=E=>{var G=zt(),M=n(G);i(G),g(()=>C(M,`${r()??""} variants found`)),a(E,G)};_(o,E=>{r()>0&&t().length>0?E(I):E(O,!1)},p)}};_(h,o=>{r()>A.variantExplorer.maxCount?o(L):o(y,!1)})}a(F,u)},(F,u)=>{st(F,{title:"Error",children:(h,L)=>{z();var y=rt();g(()=>C(y,w(u)||"An error occured while retrieving variant list.")),a(h,y)},$$slots:{default:!0}})}),a(Y,Z)};_(X,Y=>{Y(xt)})}a(s,$)},$$slots:{default:!0}}),a(c,J),kt(),k()}Ut(["click"]);export{xa as component};
