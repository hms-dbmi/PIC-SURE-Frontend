import"../chunks/Bzak7iHL.js";import{o as yt,a as Pt}from"../chunks/xU7jw7XU.js";import{p as dt,h as st,e as x,a as f,b as e,c as vt,n as O,j as W,t as M,k as t,f as T,s as Z,d as L,r as U,l as tt,i as ft,u as it,$ as Rt}from"../chunks/DhSNEPDw.js";import{d as Vt,s as K,h as qt}from"../chunks/DVtHS8ol.js";import{i as S}from"../chunks/BG76zvuN.js";import{p as Ct,s as bt,a as kt,c as gt}from"../chunks/DpjY2ypC.js";import{g as Ft}from"../chunks/Dkbkn6HV.js";import{s as lt,b as St,f as Lt}from"../chunks/BOAiLg0g.js";import{c as $t,k as Tt,e as Ut,j as Nt,f as Gt,h as zt,t as Ot}from"../chunks/M2p3ZkHt.js";import{p as mt}from"../chunks/B1n7kAsq.js";import{C as Qt}from"../chunks/5IRW-zVC.js";import{E as Y}from"../chunks/CQQkdEes.js";import{a as ot}from"../chunks/Jhkhy7E3.js";import{e as pt,i as _t}from"../chunks/ByI6iVq5.js";import{c as xt}from"../chunks/CpcxNR6b.js";import{T as ut}from"../chunks/Dmx9hz0_.js";import{g as Et}from"../chunks/C55AtZ90.js";import{L as nt}from"../chunks/CzbepVLR.js";import{b as jt,r as Bt}from"../chunks/aV0zye_u.js";import{a as Mt}from"../chunks/DPXw0ygh.js";import{S as It}from"../chunks/DoUav4w7.js";var H=(g=>(g.Full="full",g.Aggregate="aggregate",g))(H||{});function Xt(g){return g.query.expectedResultType="VARIANT_COUNT_FOR_QUERY",$t(Tt.QueryV2Sync,g).then(o=>o.count)}function ct(g,o){return o.query.expectedResultType=g===H.Aggregate?"AGGREGATE_VCF_EXCERPT":"VCF_EXCERPT",$t(Tt.QueryV2Sync,o).then(N=>{const V=URL.createObjectURL(new Blob([N],{type:"octet/stream"})),q=N.split(`
`),a=q[0].split("	"),h=lt.variantExplorer.excludeColumns.map(r=>a.indexOf(r)).filter(r=>r>=0),Q=q.slice(1).map(r=>r.split("	")).filter(r=>r.length>1).map(r=>r.reduce((l,y,b)=>(h.includes(b)||(l[a[b].toString()]=y),l),{}));return{columns:a.filter((r,l)=>!h.includes(l)).map(r=>({dataElement:r,label:r,sort:!0,filter:!0})),rows:Q,downloadUrl:V}})}function Dt(g,o,N){tt(o,!t(o)),N()(t(o))}var Kt=T('<a data-testid="variant-download-btn" class="btn btn-sm preset-tonal-primary border border-primary-500" download="variantData.tsv"><i class="fa-solid fa-download"></i> </a>'),Wt=T('<div data-testid="variant-count" class="text-left w-full"> </div>'),Yt=T('<div><label class="flex items-center space-x-2"><input class="checkbox" type="checkbox"/> <p>Aggregate data</p></label></div>'),Ht=T("<!> <!> <!>",1),Jt=T('<div data-testid="variant-count" class="flex-none w-full"> </div>'),Zt=T('<div data-testid="variant-count" class="flex-none w-full"> </div>'),te=T("<!> <!>",1);function ht(g,o){dt(o,!0);let N=Ct(o,"onAggregateToggle",3,()=>{}),V=st(o.exportType===H.Full);var q=x(),a=f(q);{var h=G=>{var Q=x(),J=f(Q);ot(J,()=>o.data,r=>{var l=te(),y=f(l);{var b=s=>{var u=Zt(),E=L(u);U(u),M(I=>K(E,`${I??""} variants found`),[()=>o.count.toLocaleString()]),e(s,u)};S(y,s=>{o.count>0&&s(b)})}var n=Z(y,2);nt(n,{ring:!0,size:"medium"}),e(r,l)},(r,l)=>{var y=x(),b=f(y);{var n=u=>{Y(u,{color:"warning",children:(E,I)=>{O();var v=W();M(w=>K(v,`Too many variants! Found ${w??""}, but cannot display more than
        ${lt.variantExplorer.maxCount??""} variants.`),[()=>o.count.toLocaleString()]),e(E,v)},$$slots:{default:!0}})},s=u=>{var E=x(),I=f(E);{var v=p=>{It(p,{tableName:"variant-explorer",get data(){return t(l).rows},get columns(){return t(l).columns},fullWidth:!0,searchable:!0,tableActions:A=>{var m=Ht(),P=f(m);{var z=d=>{var c=Kt(),F=Z(L(c));U(c),M(()=>{jt(c,"href",t(l).downloadUrl),K(F,` Download Variant${t(V)?" (Aggregate)":""} Data`)}),e(d,c)};S(P,d=>{t(l).downloadUrl&&d(z)})}var i=Z(P,2);{var C=d=>{var c=Wt(),F=L(c);U(c),M(X=>K(F,`${X??""} variants found`),[()=>o.count.toLocaleString()]),e(d,c)};S(i,d=>{o.count>0&&d(C)})}var k=Z(i,2);{var R=d=>{var c=Yt(),F=L(c),X=L(F);Bt(X),X.__click=[Dt,V,N],O(2),U(F),U(c),Mt(X,()=>t(V),j=>tt(V,j)),e(d,c)};S(k,d=>{lt.variantExplorer.type===H.Full&&d(R)})}e(A,m)},$$slots:{tableActions:!0}})},w=p=>{var $=Jt(),A=L($);U($),M(m=>K(A,`${m??""} variants found`),[()=>o.count.toLocaleString()]),e(p,$)};S(I,p=>{o.count>0&&t(l)&&t(l).rows.length>0?p(v):p(w,!1)},!0)}e(u,E)};S(b,u=>{o.count>lt.variantExplorer.maxCount?u(n):u(s,!1)})}e(r,y)},r=>{Y(r,{title:"Error",children:(l,y)=>{O();var b=W("An error occured while retrieving variant list.");e(l,b)},$$slots:{default:!0}})}),e(G,Q)};S(a,G=>{o.data&&G(h)})}e(g,q),vt()}Vt(["click"]);var ee=T('<span class="text-xs ml-1"> </span>'),re=T('<i class="fa-solid fa-triangle-exclamation text-error-500"></i> <span class="sr-only">Error</span>',1),ae=T('<span class="float-right"><!></span>'),oe=T('<div class="flex items-center"><span class="font-bold"> </span> <!></div>');function ne(g,o){dt(o,!0);const N=()=>kt(Gt,"$resourcesPromise",V),[V,q]=bt();let a=st(ft([])),h=st(""),G=st(ft(Promise.resolve()));async function Q(){await N(),tt(a,Nt().map(n=>{const s=Et(!0,n.uuid);return{name:n.name,exportType:H.Aggregate,count:Xt(s),queryRequest:s}}),!0)}function J(n){tt(h,n,!0);const s=t(a).find(u=>u.name===t(h));s&&!s.data&&(s.data=ct(s.exportType,s.queryRequest))}function r(n){const s=t(a)[n];return u=>{s.exportType=u?H.Aggregate:H.Full,s.data=ct(s.exportType,s.queryRequest)}}function l(n){const v=(w,p)=>w%p>0?(w/p).toFixed(1):Math.round(w/p);return n>=1e12?"~"+v(n,1e12)+"T":n>=1e9?"~"+v(n,1e9)+"B":n>=1e6?"~"+v(n,1e6)+"M":n>=1e3?"~"+v(n,1e3)+"K":n.toString()}yt(()=>{Ut(),tt(G,Q().then(()=>{tt(h,t(a)[0].name,!0),t(a)[0].data=ct(t(a)[0].exportType,t(a)[0].queryRequest)}),!0)});var y=x(),b=f(y);ot(b,()=>t(G),n=>{nt(n,{ring:!0,size:"medium"})},n=>{var s=x(),u=f(s);{var E=v=>{ut(v,{get value(){return t(h)},onValueChange:$=>J($.value),list:$=>{var A=x(),m=f(A);pt(m,17,()=>t(a),_t,(P,z)=>{let i=()=>t(z).name,C=()=>t(z).count;var k=x(),R=f(k);xt(R,()=>ut.Control,(d,c)=>{c(d,{get value(){return i()},children:(F,X)=>{var j=oe(),et=L(j),D=L(et,!0);U(et);var rt=Z(et,2);ot(rt,C,B=>{var _=ae(),at=L(_);nt(at,{ring:!0,size:"micro"}),U(_),e(B,_)},(B,_)=>{var at=ee(),wt=L(at);U(at),M(At=>K(wt,`(${At??""})`),[()=>l(t(_))]),e(B,at)},B=>{var _=re();O(2),e(B,_)}),U(j),M(()=>K(D,i())),e(F,j)},$$slots:{default:!0}})}),e(P,k)}),e($,A)},content:$=>{var A=x(),m=f(A);pt(m,17,()=>t(a),_t,(P,z,i)=>{const C=it(()=>{const{name:d,count:c}=t(z);return{name:d,count:c}});var k=x(),R=f(k);xt(R,()=>ut.Panel,(d,c)=>{c(d,{get value(){return t(C).name},children:(F,X)=>{var j=x(),et=f(j);ot(et,()=>t(C).count,D=>{nt(D,{ring:!0,size:"medium"})},(D,rt)=>{{let B=it(()=>r(i));ht(D,{get count(){return t(rt)},get onAggregateToggle(){return t(B)},get data(){return t(a)[i].data},set data(_){t(a)[i].data=_},get exportType(){return t(a)[i].exportType},set exportType(_){t(a)[i].exportType=_}})}},D=>{Y(D,{title:"Error",children:(rt,B)=>{O();var _=W("An error occured while loading counts and variant data.");e(rt,_)},$$slots:{default:!0}})}),e(F,j)},$$slots:{default:!0}})}),e(P,k)}),e($,A)},$$slots:{list:!0,content:!0}})},I=v=>{var w=x(),p=f(w);{var $=m=>{var P=x(),z=f(P);ot(z,()=>t(a)[0].count,i=>{nt(i,{ring:!0,size:"medium"})},(i,C)=>{{let k=it(()=>r(0));ht(i,{get count(){return t(C)},get onAggregateToggle(){return t(k)},get data(){return t(a)[0].data},set data(R){t(a)[0].data=R},get exportType(){return t(a)[0].exportType},set exportType(R){t(a)[0].exportType=R}})}},i=>{Y(i,{title:"Error",children:(C,k)=>{O();var R=W("An error occured while loading counts and variant data.");e(C,R)},$$slots:{default:!0}})}),e(m,P)},A=m=>{Y(m,{title:"Error",children:(P,z)=>{O();var i=W("No resources were found to query for variant data.");e(P,i)},$$slots:{default:!0}})};S(p,m=>{t(a).length===1?m($):m(A,!1)},!0)}e(v,w)};S(u,v=>{t(a).length>1?v(E):v(I,!1)})}e(n,s)},n=>{Y(n,{title:"Error",children:(s,u)=>{O();var E=W("An error occured while loading resource list.");e(s,E)},$$slots:{default:!0}})}),e(g,y),vt(),q()}var se=T('<h2 class="text-center clear-both">Variant Explorer</h2> <!>',1);function Re(g,o){dt(o,!0);const[N,V]=bt();yt(()=>{Et(!0).query.hasGenomicFilter()?gt(mt,!1):(zt("no-query")||Ot.error({id:"no-query",title:"No query provided. Please add a genomic filter to explore variant data.",closable:!0}),Ft("/explorer"))}),Pt(()=>gt(mt,!0)),qt(q=>{M(()=>Rt.title=`${St.applicationName??""} | Variant Explorer`)}),Qt(g,{full:!0,backUrl:"/explorer",backTitle:"Back to Explore",children:(q,a)=>{var h=se(),G=Z(f(h),2);{var Q=r=>{ne(r,{})},J=r=>{Y(r,{title:"Error",children:(l,y)=>{O();var b=W(`Variant explorer feature has not been enabled in this environment. Please contact an admin if
      you have any questions.`);e(l,b)},$$slots:{default:!0}})};S(G,r=>{Lt.explorer.variantExplorer?r(Q):r(J,!1)})}e(q,h)},$$slots:{default:!0}}),vt(),V()}export{Re as component};
