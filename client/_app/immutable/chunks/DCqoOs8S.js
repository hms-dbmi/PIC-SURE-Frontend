import{w as c}from"./BMKj-mzl.js";import{p as w}from"./BmKPRyWy.js";import{p as f,u as P,g as T}from"./BF5nqrJG.js";import{D as _}from"./CnlG47Jq.js";import{l as a}from"./CDvIr29H.js";import"./ByE-_V18.js";const y=c(!1),E=c(Promise.resolve(void 0)),i=c(""),o=c([]),u=new _([],{rowsPerPage:10}),g=c(!0),p=c("");o.subscribe(()=>{u.setPage(1),u.invalidate()});i.subscribe(()=>{u.setPage(1),u.invalidate()});u.onChange(async e=>{const r=a(i),s=a(o);y.set(!0),a(g)&&(r||s.length>0)&&g.set(!1);try{return N.set(L()),await b(e)}catch{return[]}finally{y.set(!1)}});async function b(e){const r=a(o),s=a(i);if(!s&&!r.length)return e==null||e.setTotalRows(0),[];const t=I(s.trim(),r,{pageNumber:e!=null&&e.pageNumber?(e==null?void 0:e.pageNumber)-1:0,pageSize:e==null?void 0:e.rowsPerPage});E.set(t);const n=await t.catch(m=>{throw console.error(m),e==null||e.setTotalRows(0),p.set("An error occurred while searching. If the problem persists, please contact an administrator."),m});return n||p.set("An error occurred while searching. If the problem persists, please contact an administrator."),e==null||e.setTotalRows((n==null?void 0:n.totalElements)??0),(n==null?void 0:n.content)??[]}async function R(e){const r=a(o);e.forEach(s=>{const t=r.findIndex(n=>n.name===s.name);t!==-1?r.splice(t,1):r.push(s)}),o.set(r.sort((s,t)=>t.count-s.count))}function $(){i.set(""),o.set([]),p.set(""),g.set(!0)}const J={selectedFacets:o,searchTerm:i,error:p,search:b,updateFacets:R,resetSearch:$},C="picsure/proxy/dictionary-api/",F="picsure/proxy/dictionary-api/concepts",D="picsure/proxy/dictionary-api/concepts/detail/",S="picsure/proxy/dictionary-api/dashboard-drawer/",v=c({}),N=c(Promise.resolve([])),l=new Map;function x(e,r){!e||!r||(l.size>100&&l.clear(),l.set(e,r))}function I(e="",r,s){let t={facets:r,search:e};return a(w).url.pathname.includes("/discover")||(t=d(t)),f(`${F}?page_number=${s.pageNumber}&page_size=${s.pageSize}`,t)}function z(e){const r=e.map(s=>({name:s.name,values:s.facets.filter(t=>t.count===0).map(t=>t.name)})).reduce((s,t)=>(s[t.name]=t.values,s),{});console.debug("Found the following facets that should be hidden:",JSON.stringify(r)),v.set(r)}async function L(){const e=a(i);let s={facets:a(o),search:e};a(w).url.pathname.includes("/discover")||(s=d(s));try{const t=await f(`${C}facets/`,s);return z(t),U(t),t}catch(t){throw console.error("Failed to update facets from search:",t),t}}function U(e){e.forEach(r=>{r.facets.forEach(s=>{var t;s.categoryRef={name:r.name,display:r.display,description:r.description},(t=s.children)!=null&&t.length&&s.children.forEach(n=>{n.categoryRef={name:r.name,display:r.display,description:r.description},n.parentRef={name:s.name,display:s.display,description:s.description}})})})}async function W(e,r){const s=`${D}${r}`,t=String.raw`${e.replace(/\\\\/g,"\\")}`;if(l.has(t))return l.get(t);const n=await f(s,t);if(!n)throw new Error("No response");return x(t,n),n}function d(e){var s;const r=(s=a(P))==null?void 0:s.queryTemplate;if(r){const n=(r.categoryFilters||{})["\\_consents\\"]||[];e.consents=n}return e}async function Z(e=!1){let r={facets:[],search:"",consents:[]};return e||(r=d(r)),(await f(`${F}?page_number=1&page_size=1`,r)).totalElements||Promise.reject("total not found")}async function k(e=!1,r){let s={facets:[],search:"",consents:[]};e||(s=d(s));const n=(await f(`${C}facets/`,s)).find(h=>h.name===r);return n?e?n.facets.length:n.facets.filter(h=>h.count>0).length:0}async function B(e){return T(`${S}${e}`)}export{J as S,k as a,Z as b,o as c,E as d,i as e,N as f,W as g,v as h,p as i,u as j,B as k,y as l,$ as r,I as s,g as t};
