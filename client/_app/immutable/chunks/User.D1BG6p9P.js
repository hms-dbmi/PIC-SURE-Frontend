import{w as y,d as w,g as E}from"./entry.D9nKiiu7.js";import{e as f}from"./index.CJi4hZKd.js";import{r as g,P as S,f as m,B as p,a as v}from"./configuration.CIpdfyUx.js";import{r as c}from"./scheduler.bui7uCNy.js";import{p as x}from"./stores.CGSu9-ky.js";const h="Bearer ";async function u({method:e,path:r,data:t,headers:a}){const n={method:e,headers:{}};t&&(n.headers["Content-Type"]="application/json",n.body=typeof t=="string"?t:JSON.stringify(t)),a&&(n.headers={...n.headers,...a});{const o=localStorage.getItem("token");o&&(n.headers.Authorization=`${h}${o}`,n.headers["request-source"]="Authorized"),c(x).url.pathname.includes("/discover")&&(n.headers["request-source"]="Open")}const i=await fetch(`${window.location.origin}/${r}`,n);return await I(i)}function l(e,r){return u({method:"GET",path:e,headers:r})}function L(e,r){return u({method:"DELETE",path:e,headers:r})}function z(e,r,t){return u({method:"POST",path:e,data:r,headers:t})}function B(e,r,t){return u({method:"PUT",path:e,data:r,headers:t})}async function I(e){if(e.ok||e.status===422){A(e);const r=await e.text();try{return JSON.parse(r)}catch{return r}}else if(e.status===401)throw b(),f(401,"Unauthorized");throw f(e.status,await e.text())}function A(e){let r=e.headers.get("Authorization");r&&(r=r.replace(h,""),P(r))}const s=y(O());s.subscribe(e=>{{d();const r={...e};r.token=void 0,localStorage.setItem("user",JSON.stringify(r))}});function O(){if(localStorage.getItem("user")){d();try{const e=JSON.parse(localStorage.getItem("user")||"{}");return!e||Object.keys(e).length===0?{}:(console.log("Restored user from local storage: ",e),e)}catch(e){return console.error("Error reading user from local storage:  "+e),{}}}return{}}function d(){{const e=localStorage.getItem("token");e&&q(e)&&(console.log("Clearing expired token from local storage."),localStorage.removeItem("token"))}}const j=w(s,e=>{const r=(e==null?void 0:e.privileges)||[];if(r.length===0)return g.filter(i=>!i.privilege);function t(i){return i.filter(o=>o.feature?!!m[o.feature]:!0).map(o=>o.children?{...o,children:t(o.children)}:o)}const a=t(g);if(r.includes(S.SUPER))return a;function n(i){return i.filter(o=>o.privilege?o.privilege.some(T=>r.includes(T)):!0).map(o=>o.children?{...o,children:n(o.children)}:o)}return n(a)});async function R(e,r=!1){{const t=await l(`psama/user/me${r?"?hasToken":""}`);if(t.privileges&&t.token){for(const a of t.privileges)if(a.includes(p.PRIV_MANAGED)){t.privileges.push(p.AUTHORIZED_ACCESS);break}}s.set({...c(s),...t})}}async function G(){const e=await l("psama/user/me/refresh_long_term_token").then(r=>{if(!r.userLongTermToken)throw new Error("No user token was returned.");return r.userLongTermToken});s.set({...c(s),token:e})}async function N(){try{const e=await l("psama/user/me/queryTemplate/"+v.application);return JSON.parse(e.queryTemplate)}catch(e){return console.error("Error parsing query template: "+e),{}}}async function P(e){if(e&&(localStorage.setItem("token",e),await R(!0,!1),m.useQueryTemplate)){const r=await N();r&&s.set({...c(s),queryTemplate:r})}}async function b(){{const e=localStorage.getItem("token");e&&l("/psama/logout"),e&&localStorage.removeItem("token")}s.set({}),E("/login")}function q(e){try{return k(e)<new Date().getTime()}catch(r){return console.error("Error checking token expiration: "+r),!0}}function k(e){if(!e)throw new Error("No token provided.");try{return JSON.parse(atob(e.split(".")[1])).exp*1e3}catch(r){throw new Error("Error parsing token: "+r)}}function Q(e){try{return new Date(k(e))}catch(r){console.error("Error getting token expiration as date: "+r);return}}export{B as a,R as b,k as c,L as d,Q as e,j as f,l as g,b as h,q as i,P as l,z as p,G as r,s as u};
