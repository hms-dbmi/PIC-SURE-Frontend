import{w as y,d as p,g as d}from"./BMKj-mzl.js";import{e as O}from"./BJ9VUBsT.js";import{P as w,r as h,f as P,B as k,a as R}from"./BmRh3WJ6.js";import{p as S}from"./BmKPRyWy.js";import{l as c}from"./CDvIr29H.js";const E="Bearer ";async function u({method:e,path:t,data:r,headers:n}){const s={method:e,headers:{}};r&&(s.headers["Content-Type"]="application/json",s.body=typeof r=="string"?r:JSON.stringify(r)),n&&(s.headers={...s.headers,...n});{const i=localStorage.getItem("token");i&&(s.headers.Authorization=`${E}${i}`,s.headers["request-source"]="Authorized"),c(S).url.pathname.includes("/discover")&&(s.headers["request-source"]="Open")}const l=await fetch(`${window.location.origin}/${t}`,s);return await N(l)}function g(e,t){return u({method:"GET",path:e,headers:t})}function M(e,t){return u({method:"DELETE",path:e,headers:t})}function Q(e,t,r){return u({method:"POST",path:e,data:t,headers:r})}function Y(e,t,r){return u({method:"PUT",path:e,data:t,headers:r})}async function N(e){if(e.ok||e.status===422){if(b(e),(e.headers.get("Content-Type")||"").includes("application/octet-stream"))return await e.arrayBuffer();const r=await e.text();try{return JSON.parse(r)}catch{return r}}else if(e.status===401){sessionStorage.setItem("logout-reason","Your session has timed out. Please log in."),T(void 0,!0);return}else e.status===403&&(sessionStorage.removeItem("logout-reason"),sessionStorage.removeItem("filters"),T(void 0,!1));throw O(e.status,await e.text())}function b(e){let t=e.headers.get("Authorization");t&&(t=t.replace(E,""),U(t))}const a=y(D()),Z=p(a,e=>{var t;return(t=e==null?void 0:e.privileges)==null?void 0:t.includes(w.SUPER)});function q(e,t){const r=y(!!localStorage.getItem(e));return window.addEventListener("storage",n=>{n.key===e&&r.set(!!n.newValue)}),r}const m=q("token"),C=p(m,e=>e);a.subscribe(e=>{{I();const t={...e};t.token=void 0,localStorage.setItem("user",JSON.stringify(t))}});function L(e){localStorage.setItem("token",e),m.set(!0)}function v(){localStorage.removeItem("token"),m.set(!1)}function D(){if(localStorage.getItem("user")){I();try{const e=JSON.parse(localStorage.getItem("user")||"{}");return!e||Object.keys(e).length===0?{}:(console.log("Restored user from local storage: ",e),e)}catch(e){return console.error("Error reading user from local storage:  "+e),{}}}return{}}function F(){return!!localStorage.getItem("token")}function I(){{const e=localStorage.getItem("token");e&&B(e)&&(console.log("Clearing expired token from local storage."),v())}}const K=p([a,C],([e,t])=>{const r=(e==null?void 0:e.privileges)||[];if(r.length===0||!t)return h.filter(i=>!i.privilege);function n(i){return i.filter(o=>o.feature?!!P[o.feature]:!0).map(o=>o.children?{...o,children:n(o.children)}:o)}const s=n(h);if(r.includes(w.SUPER))return s;function l(i){return i.filter(o=>o.privilege?o.privilege.some(A=>r.includes(A)):!0).map(o=>o.children?{...o,children:l(o.children)}:o)}return l(s)});async function _(e,t=!1){{const r=await g(`psama/user/me${t?"?hasToken":""}`);if(r.privileges&&r.token){for(const n of r.privileges)if(n.includes(k.PRIV_MANAGED)){r.privileges.push(k.AUTHORIZED_ACCESS);break}}a.set({...c(a),...r})}}async function W(){const e=await g("psama/user/me/refresh_long_term_token").then(t=>{if(!t.userLongTermToken)throw new Error("No user token was returned.");return t.userLongTermToken});a.set({...c(a),token:e})}async function J(){try{const e=await g("psama/user/me/queryTemplate/"+R.application);return JSON.parse(e.queryTemplate)}catch(e){return console.error("Error parsing query template: "+e),{}}}async function U(e){if(e){L(e),await _(!0,!1);{const t=await J();t&&a.set({...c(a),queryTemplate:t})}}}async function T(e,t=!1){localStorage.getItem("token")&&(g("/psama/logout").catch(n=>{console.error("Error logging out: "+n)}),v()),e?e.logout().then(r=>{typeof r=="string"?(a.set({}),location.replace(r)):(console.error("Error logging out: "+r),f(t))}).catch(r=>{console.error("Error logging out: "+r),f(t)}):f(t)}function f(e){a.set({}),e?d(`/login?redirectTo=${encodeURIComponent(c(S).url.pathname)}`):d("/login")}function B(e){try{return x(e)<new Date().getTime()}catch(t){return console.error("Error checking token expiration: "+t),!0}}function x(e){if(!e)throw new Error("No token provided.");try{return JSON.parse(atob(e.split(".")[1])).exp*1e3}catch(t){throw new Error("Error parsing token: "+t)}}function X(e){try{return new Date(x(e))}catch(t){console.error("Error getting token expiration as date: "+t);return}}export{Z as a,Y as b,_ as c,M as d,x as e,X as f,g,F as h,B as i,C as j,K as k,U as l,T as m,Q as p,W as r,a as u};
