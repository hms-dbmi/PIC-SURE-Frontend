import{Q as h,g as _,f as v,h as C,b as T,c as V}from"./DA3-ipRP.js";import{f as i}from"./BZHGrlEE.js";import{g as r}from"./xU7jw7XU.js";import{r as u,u as y}from"./BNC-bmXQ.js";import{e as R}from"./eUoM9-xI.js";const l="\\DCC Harmonized data set",f="\\_harmonized_consent\\",F="\\_topmed_consents\\";function S(e=!0,n=r(u).hpdsAuth,a="COUNT",o=t=>t){return z(!e,n,a,t=>([...r(_),...r(v)].forEach(s=>{s.filterType==="Categorical"?s.displayType==="restrict"?t.addCategoryFilter(s.id,s.categoryValues):t.addRequiredField(s.id):s.filterType==="numeric"?t.addNumericFilter(s.id,s.min||"",s.max||""):s.filterType==="genomic"?t.addCategoryVariantInfoFilters({Gene_with_variant:s.Gene_with_variant,Variant_consequence_calculated:s.Variant_consequence_calculated,Variant_frequency_as_text:s.Variant_frequency_as_text}):s.filterType==="snp"?t.addSnpFilter(s.snpValues):s.filterType==="AnyRecordOf"&&t.addAnyRecordOfMulti(s.concepts)}),r(R).forEach(s=>{s.conceptPath&&t.addField(s.conceptPath)}),o(t)))}function z(e=!1,n=r(u).hpdsAuth,a="COUNT",o=t=>t){let t=new h;if(i.useQueryTemplate&&!e){const s=r(y).queryTemplate;s&&(t=new h(structuredClone(s)))}return t=o(t),i.requireConsents&&!e&&(t=P(t)),t.expectedResultType=a,{query:t,resourceUUID:n}}const P=e=>(!d(e.categoryFilters)&&!d(e.numericFilters)&&!m(e.fields)&&!m(e.requiredFields)&&e.removeCategoryFilter(f),r(C)||e.removeCategoryFilter(F),e),d=e=>Object.keys(e).some(n=>n.includes(l)),m=e=>e.some(n=>n.includes(l)),c=e=>{if(e==null)return;if(typeof e=="number")return Number.isFinite(e)?e:void 0;const n=e.trim();if(n==="")return;const a=n.replace(/[,_\s\u00A0\u202F]/g,""),o=Number(a);return Number.isFinite(o)?o:void 0};function x(e){return JSON.parse(JSON.stringify(e,(n,a)=>{if(n!=="type")return a}))}function E(e){if(e.root.children.length===0)return null;const n=o=>({type:"PhenotypicSubquery",operator:o,phenotypicClauses:[],not:!1}),a=o=>{if(e.isGroup(o)){const t=n(o.operator);return t.phenotypicClauses=o.children.map(a),t}return N(o)};return a(e.root)}function L(e=!0,n=r(u).hpdsAuth,a="COUNT",o=t=>t){return b(!e,n,a,t=>(t.phenotypicClause=E(r(V)),r(_).forEach(s=>{s.filterType==="snp"?Q(s).forEach(p=>{t.genomicFilters.push(p)}):s.filterType==="genomic"&&O(s).forEach(p=>{t.genomicFilters.push(p)})}),o(t)))}function b(e=!1,n=r(u).hpdsAuth,a="COUNT",o=t=>t){let t=new T;return t.expectedResultType=a,t=o(t),i.requireConsents&&!e&&w(t),{query:x(t),resourceUUID:n}}function w(e){if(i.useQueryTemplate){const n=r(y).queryTemplate;if(n){const a=n.categoryFilters;if(a){const o=a["\\_consents\\"]||[];o.length>0&&e.authorizationFilters.push({conceptPath:"\\_consents\\",values:o});const t=a["\\_harmonized_consent\\"]||[];t.length>0&&e.authorizationFilters.push({conceptPath:"\\_harmonized_consent\\",values:t});const s=a["\\_topmed_consents\\"]||[];s.length>0&&e.authorizationFilters.push({conceptPath:"\\_topmed_consents\\",values:s})}}}if(i.requireConsents){const n=G(e.select||[]),a=g(e.phenotypicClause);n||a||(e.authorizationFilters=(e.authorizationFilters||[]).filter(s=>s.conceptPath!==f)),(e.genomicFilters||[]).length>0||(e.authorizationFilters=(e.authorizationFilters||[]).filter(s=>s.conceptPath!==F))}}const G=e=>e.some(n=>n.includes(l)),g=e=>{if(!e)return!1;if(e.type==="PhenotypicFilter"){const a=e;return!!a.conceptPath&&a.conceptPath.includes(l)}return(e.phenotypicClauses||[]).some(g)},N=e=>{var a;const n={type:"PhenotypicFilter",phenotypicFilterType:I(e.filterType),conceptPath:e.id,not:!1};switch(e.filterType){case"AnyRecordOf":n.phenotypicFilterType="ANY_RECORD_OF",n.values=e.concepts;break;case"required":n.phenotypicFilterType="REQUIRED";break;case"numeric":e.min===void 0&&e.max===void 0&&(n.phenotypicFilterType="REQUIRED"),e.min!==void 0&&(n.min=c(e.min)),e.max!==void 0&&(n.max=c(e.max));break;case"Categorical":(a=e.categoryValues)!=null&&a.length?n.values=e.categoryValues:n.phenotypicFilterType="REQUIRED";break}return n},O=e=>{const n=[],a=e.min!==void 0&&e.min!==""||e.max!==void 0&&e.max!=="",o=e.Gene_with_variant&&e.Gene_with_variant.length>0||e.Variant_consequence_calculated&&e.Variant_consequence_calculated.length>0||e.Variant_frequency_as_text&&e.Variant_frequency_as_text.length>0;if(a&&!o){const t=e.min?c(e.min):void 0,s=e.max?c(e.max):void 0;return A("genomic_range",t,s)}return e.Gene_with_variant&&e.Gene_with_variant.length>0&&n.push({key:"Gene_with_variant",values:e.Gene_with_variant}),e.Variant_consequence_calculated&&e.Variant_consequence_calculated.length>0&&n.push({key:"Variant_consequence_calculated",values:e.Variant_consequence_calculated}),e.Variant_frequency_as_text&&e.Variant_frequency_as_text.length>0&&n.push({key:"Variant_frequency_as_text",values:e.Variant_frequency_as_text}),n},Q=e=>{const n=[];return(e.snpValues||[]).forEach(a=>{n.push({key:a.search,values:a.constraint.split(",")})}),n},A=(e,n,a)=>n!==void 0&&a!==void 0?[{key:e,min:n,max:a}]:n!==void 0?[{key:e,min:n}]:a!==void 0?[{key:e,max:a}]:[];function I(e){switch(e){case"Categorical":case"numeric":return"FILTER";case"AnyRecordOf":return"ANY_RECORD_OF";case"required":return"REQUIRED";case"snp":return"FILTER"}return"FILTER"}export{z as a,L as b,b as c,S as g,P as u};
