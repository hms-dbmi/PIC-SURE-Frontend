import{w as S,d as v,g as f}from"./entry.BzyMyMCS.js";import{e as I}from"./index.RDckgBtK.js";import{r as p,P as x,f as d,B as m,a as A}from"./configuration.D7nHe1C4.js";import{p as k}from"./stores.WcJ0rjcA.js";import{r as l}from"./scheduler.bui7uCNy.js";const T="Bearer ";async function c({method:e,path:r,data:t,headers:a}){const n={method:e,headers:{}};t&&(n.headers["Content-Type"]="application/json",n.body=typeof t=="string"?t:JSON.stringify(t)),a&&(n.headers={...n.headers,...a});{const o=localStorage.getItem("token");o&&(n.headers.Authorization=`${T}${o}`,n.headers["request-source"]="Authorized"),l(k).url.pathname.includes("/discover")&&(n.headers["request-source"]="Open")}const i=await fetch(`${window.location.origin}/${r}`,n);return await O(i)}function u(e,r){return c({method:"GET",path:e,headers:r})}function U(e,r){return c({method:"DELETE",path:e,headers:r})}function z(e,r,t){return c({method:"POST",path:e,data:r,headers:t})}function j(e,r,t){return c({method:"PUT",path:e,data:r,headers:t})}async function O(e){if(e.ok||e.status===422){N(e);const r=await e.text();try{return JSON.parse(r)}catch{return r}}else if(e.status===401){sessionStorage.setItem("logout-reason","Your session has timed out. Please log in."),h(void 0,!0);return}else if(e.status===403){sessionStorage.removeItem("logout-reason"),sessionStorage.removeItem("filters"),h(void 0,!1);return}throw I(e.status,await e.text())}function N(e){let r=e.headers.get("Authorization");r&&(r=r.replace(T,""),q(r))}const s=S(P());s.subscribe(e=>{{y();const r={...e};r.token=void 0,localStorage.setItem("user",JSON.stringify(r))}});function P(){if(localStorage.getItem("user")){y();try{const e=JSON.parse(localStorage.getItem("user")||"{}");return!e||Object.keys(e).length===0?{}:(console.log("Restored user from local storage: ",e),e)}catch(e){return console.error("Error reading user from local storage:  "+e),{}}}return{}}function y(){{const e=localStorage.getItem("token");e&&C(e)&&(console.log("Clearing expired token from local storage."),localStorage.removeItem("token"))}}const G=v(s,e=>{const r=(e==null?void 0:e.privileges)||[];if(r.length===0)return p.filter(i=>!i.privilege);function t(i){return i.filter(o=>o.feature?!!d[o.feature]:!0).map(o=>o.children?{...o,children:t(o.children)}:o)}const a=t(p);if(r.includes(x.SUPER))return a;function n(i){return i.filter(o=>o.privilege?o.privilege.some(E=>r.includes(E)):!0).map(o=>o.children?{...o,children:n(o.children)}:o)}return n(a)});async function R(e,r=!1){{const t=await u(`psama/user/me${r?"?hasToken":""}`);if(t.privileges&&t.token){for(const a of t.privileges)if(a.includes(m.PRIV_MANAGED)){t.privileges.push(m.AUTHORIZED_ACCESS);break}}s.set({...l(s),...t})}}async function Q(){const e=await u("psama/user/me/refresh_long_term_token").then(r=>{if(!r.userLongTermToken)throw new Error("No user token was returned.");return r.userLongTermToken});s.set({...l(s),token:e})}async function b(){try{const e=await u("psama/user/me/queryTemplate/"+A.application);return JSON.parse(e.queryTemplate)}catch(e){return console.error("Error parsing query template: "+e),{}}}async function q(e){if(e&&(localStorage.setItem("token",e),await R(!0,!1),d.useQueryTemplate)){const r=await b();r&&s.set({...l(s),queryTemplate:r})}}async function h(e,r=!1){localStorage.getItem("token")&&(u("/psama/logout").catch(a=>{console.error("Error logging out: "+a)}),localStorage.removeItem("token")),e?e.logout().then(t=>{typeof t=="string"?(s.set({}),location.replace(t)):(console.error("Error logging out: "+t),g(r))}).catch(t=>{console.error("Error logging out: "+t),g(r)}):g(r)}function g(e){s.set({}),e?f(`/login?redirectTo=${encodeURIComponent(l(k).url.pathname)}`):f("/login")}function C(e){try{return w(e)<new Date().getTime()}catch(r){return console.error("Error checking token expiration: "+r),!0}}function w(e){if(!e)throw new Error("No token provided.");try{return JSON.parse(atob(e.split(".")[1])).exp*1e3}catch(r){throw new Error("Error parsing token: "+r)}}function $(e){try{return new Date(w(e))}catch(r){console.error("Error getting token expiration as date: "+r);return}}export{j as a,R as b,w as c,U as d,$ as e,G as f,u as g,h,C as i,q as l,z as p,Q as r,s as u};
