var $=Object.defineProperty;var W=(e,t,r)=>t in e?$(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var l=(e,t,r)=>W(e,typeof t!="symbol"?t+"":t,r);import{w as I,d as G,g as u}from"./xU7jw7XU.js";import{u as j}from"./BNC-bmXQ.js";const A=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function w(e){return typeof e=="string"&&A.test(e)}function B(e){if(!w(e))throw TypeError("Invalid UUID");var t,r=new Uint8Array(16);return r[0]=(t=parseInt(e.slice(0,8),16))>>>24,r[1]=t>>>16&255,r[2]=t>>>8&255,r[3]=t&255,r[4]=(t=parseInt(e.slice(9,13),16))>>>8,r[5]=t&255,r[6]=(t=parseInt(e.slice(14,18),16))>>>8,r[7]=t&255,r[8]=(t=parseInt(e.slice(19,23),16))>>>8,r[9]=t&255,r[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,r[11]=t/4294967296&255,r[12]=t>>>24&255,r[13]=t>>>16&255,r[14]=t>>>8&255,r[15]=t&255,r}var p=[];for(var M=0;M<256;++M)p.push((M+256).toString(16).slice(1));function L(e,t=0){return(p[e[t+0]]+p[e[t+1]]+p[e[t+2]]+p[e[t+3]]+"-"+p[e[t+4]]+p[e[t+5]]+"-"+p[e[t+6]]+p[e[t+7]]+"-"+p[e[t+8]]+p[e[t+9]]+"-"+p[e[t+10]]+p[e[t+11]]+p[e[t+12]]+p[e[t+13]]+p[e[t+14]]+p[e[t+15]]).toLowerCase()}var E,b=new Uint8Array(16);function Q(){if(!E&&(E=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!E))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return E(b)}function tt(e){e=unescape(encodeURIComponent(e));for(var t=[],r=0;r<e.length;++r)t.push(e.charCodeAt(r));return t}var rt="6ba7b810-9dad-11d1-80b4-00c04fd430c8",et="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function nt(e,t,r){function n(i,a,o,s){var d;if(typeof i=="string"&&(i=tt(i)),typeof a=="string"&&(a=B(a)),((d=a)===null||d===void 0?void 0:d.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var c=new Uint8Array(16+i.length);if(c.set(a),c.set(i,a.length),c=r(c),c[6]=c[6]&15|t,c[8]=c[8]&63|128,o){s=s||0;for(var f=0;f<16;++f)o[s+f]=c[f];return o}return L(c)}try{n.name=e}catch{}return n.DNS=rt,n.URL=et,n}var it=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const P={randomUUID:it};function k(e,t,r){if(P.randomUUID&&!e)return P.randomUUID();e=e||{};var n=e.random||(e.rng||Q)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,L(n)}function at(e,t,r,n){switch(e){case 0:return t&r^~t&n;case 1:return t^r^n;case 2:return t&r^t&n^r&n;case 3:return t^r^n}}function D(e,t){return e<<t|e>>>32-t}function ot(e){var t=[1518500249,1859775393,2400959708,3395469782],r=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof e=="string"){var n=unescape(encodeURIComponent(e));e=[];for(var i=0;i<n.length;++i)e.push(n.charCodeAt(i))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);for(var a=e.length/4+2,o=Math.ceil(a/16),s=new Array(o),d=0;d<o;++d){for(var c=new Uint32Array(16),f=0;f<16;++f)c[f]=e[d*64+f*4]<<24|e[d*64+f*4+1]<<16|e[d*64+f*4+2]<<8|e[d*64+f*4+3];s[d]=c}s[o-1][14]=(e.length-1)*8/Math.pow(2,32),s[o-1][14]=Math.floor(s[o-1][14]),s[o-1][15]=(e.length-1)*8&4294967295;for(var x=0;x<o;++x){for(var m=new Uint32Array(80),T=0;T<16;++T)m[T]=s[x][T];for(var F=16;F<80;++F)m[F]=D(m[F-3]^m[F-8]^m[F-14]^m[F-16],1);for(var y=r[0],C=r[1],S=r[2],_=r[3],N=r[4],V=0;V<80;++V){var R=Math.floor(V/20),Z=D(y,5)+at(R,C,S,_)+N+t[R]+m[V]>>>0;N=_,_=S,S=D(C,30)>>>0,C=y,y=Z}r[0]=r[0]+y>>>0,r[1]=r[1]+C>>>0,r[2]=r[2]+S>>>0,r[3]=r[3]+_>>>0,r[4]=r[4]+N>>>0}return[r[0]>>24&255,r[0]>>16&255,r[0]>>8&255,r[0]&255,r[1]>>24&255,r[1]>>16&255,r[1]>>8&255,r[1]&255,r[2]>>24&255,r[2]>>16&255,r[2]>>8&255,r[2]&255,r[3]>>24&255,r[3]>>16&255,r[3]>>8&255,r[3]&255,r[4]>>24&255,r[4]>>16&255,r[4]>>8&255,r[4]&255]}var st=nt("v5",80,ot);const ct=k();function g(){return k()}function K(e){return st(JSON.stringify(e),ct)}var lt=(e=>(e.None="none",e.Genomic="genomic",e.SNP="snp",e))(lt||{}),dt=(e=>(e.Heterozygous="0/1",e.Homozygous="1/1",e.HeterozygousOrHomozygous="1/1,0/1",e.Neither="0/0",e))(dt||{});const ft={"0/1":"Heterozygous","1/1":"Homozygous","1/1,0/1":"Heterozygous or Homozygous","0/1,1/1":"Heterozygous or Homozygous"};class Ft{constructor(t){l(this,"categoryFilters");l(this,"numericFilters");l(this,"requiredFields");l(this,"anyRecordOf");l(this,"anyRecordOfMulti");l(this,"fields");l(this,"crossCountFields");l(this,"variantInfoFilters");l(this,"expectedResultType");var n;this.categoryFilters=(t==null?void 0:t.categoryFilters)||{},this.numericFilters=(t==null?void 0:t.numericFilters)||{},this.requiredFields=(t==null?void 0:t.requiredFields)||[],this.anyRecordOf=(t==null?void 0:t.anyRecordOf)||[],this.anyRecordOfMulti=(t==null?void 0:t.anyRecordOfMulti)||[],this.crossCountFields=(t==null?void 0:t.crossCountFields)||[],this.fields=(t==null?void 0:t.fields)||[];const r=((n=t==null?void 0:t.variantInfoFilters)==null?void 0:n[0])||{categoryVariantInfoFilters:{},numericVariantInfoFilters:{}};this.variantInfoFilters=[r],this.expectedResultType=(t==null?void 0:t.expectedResultType)||"COUNT"}addCategoryFilter(t,r){this.categoryFilters[t]=r}removeCategoryFilter(t){delete this.categoryFilters[t]}addNumericFilter(t,r,n){this.numericFilters[t]={min:r.toString(),max:n.toString()}}addCategoryVariantInfoFilters(t){this.variantInfoFilters[0].categoryVariantInfoFilters={Gene_with_variant:t.Gene_with_variant,Variant_consequence_calculated:t.Variant_consequence_calculated,Variant_frequency_as_text:t.Variant_frequency_as_text}}addAnyRecordOfMulti(t){this.anyRecordOfMulti.push(t)}setCrossCountFields(t){this.crossCountFields=t}addSnpFilter(t){t.forEach(r=>{this.categoryFilters[r.search]=r.constraint.split(",")})}addRequiredField(t){this.requiredFields.includes(t)||this.requiredFields.push(t)}addField(t){this.fields.includes(t)||this.fields.push(t)}addAnyRecordOf(t){this.anyRecordOf.includes(t)||this.anyRecordOf.push(t)}hasGenomicFilter(){var i,a,o,s,d,c,f,x,m;const t=((o=(a=(i=this.variantInfoFilters[0])==null?void 0:i.categoryVariantInfoFilters)==null?void 0:a.Gene_with_variant)==null?void 0:o.length)||0,r=((c=(d=(s=this.variantInfoFilters[0])==null?void 0:s.categoryVariantInfoFilters)==null?void 0:d.Variant_consequence_calculated)==null?void 0:c.length)||0,n=((m=(x=(f=this.variantInfoFilters[0])==null?void 0:f.categoryVariantInfoFilters)==null?void 0:x.Variant_frequency_as_text)==null?void 0:m.length)||0;return t+r+n}hasFilter(){return Object.keys(this.categoryFilters).length+Object.keys(this.numericFilters).length+this.hasGenomicFilter()+this.requiredFields.length+this.anyRecordOf.length}}const O={AND:"AND",OR:"OR"};class Ot{constructor(t){l(this,"select");l(this,"authorizationFilters");l(this,"phenotypicClause");l(this,"genomicFilters");l(this,"expectedResultType");l(this,"picsureId");l(this,"id");this.select=(t==null?void 0:t.select)||[],this.authorizationFilters=(t==null?void 0:t.authorizationFilters)||[],this.phenotypicClause=(t==null?void 0:t.phenotypicClause)||null,this.genomicFilters=(t==null?void 0:t.genomicFilters)||[],this.expectedResultType=(t==null?void 0:t.expectedResultType)||"COUNT",this.picsureId=(t==null?void 0:t.picsureId)||null,this.id=(t==null?void 0:t.id)||null}}class H extends Error{constructor(t){super(t)}}function pt(e=[],t=O.AND){const n={filterType:"FilterGroup",displayType:"group",variableName:"none",dataset:"",allowFiltering:!0,uuid:g(),children:e,operator:t,parent:void 0,get id(){return`filter-group-${this.uuid}`}};return e.forEach(i=>i.parent=n),n}function It(e,t){return{parent:void 0,uuid:g(),id:e.conceptPath,filterType:"Categorical",displayType:t&&(t==null?void 0:t.length)>0?"restrict":"anyRecordOf",searchResult:e,categoryValues:t||[],variableName:e.display||e.name,description:e.description,allowFiltering:e.allowFiltering,dataset:e.dataset}}function Gt(e){return{parent:void 0,uuid:g(),id:e.conceptPath,filterType:"Categorical",displayType:"any",searchResult:e,variableName:e.display||e.name,description:e.description,categoryValues:[],allowFiltering:e.allowFiltering,dataset:e.dataset}}function X(e){return e.flatMap(t=>[t.conceptPath,...(t.children||[]).flatMap(r=>X([r]))])}function Tt(e,t){const r=X((t==null?void 0:t.children)||[]);if(r.length===0)throw new H("No concept paths found");if(r.length>9500)throw new H("Too many concept paths found");return{parent:void 0,uuid:g(),id:e.conceptPath,concepts:r,filterType:"AnyRecordOf",displayType:"anyRecordOf",searchResult:e,variableName:e.name||e.display||e.conceptPath,description:e.description,allowFiltering:e.allowFiltering,dataset:e.dataset}}function yt(e,t,r){return{parent:void 0,uuid:g(),id:e.conceptPath,filterType:"numeric",displayType:t!==void 0&&r!==void 0?"between":t!==void 0?"greaterThan":r!==void 0?"lessThan":"any",searchResult:e,min:t!==void 0?t.toLocaleString():void 0,max:r!==void 0?r.toLocaleString():void 0,variableName:e.display||e.name,description:e.description,allowFiltering:e.allowFiltering,dataset:e.dataset}}function Ct(e){const t=(a,o)=>o&&o.length>0?`${a}: ${o.join(", ")}`:void 0,r=[t("Gene with variant",e.Gene_with_variant),t("Variant frequency",e.Variant_frequency_as_text),t("Consequence Group by severity",e.Variant_consequence_calculated)].filter(a=>a);if(e.min!==void 0||e.max!==void 0){const a=[];e.min!==void 0&&a.push(`min: ${e.min}`),e.max!==void 0&&a.push(`max: ${e.max}`),r.push(`Range: ${a.join(", ")}`)}const n=r.join("; ");return{parent:void 0,uuid:g(),id:"genomic",filterType:"genomic",displayType:"any",variableName:"Genomic Filter",description:n,Gene_with_variant:e.Gene_with_variant,Variant_consequence_calculated:e.Variant_consequence_calculated,Variant_frequency_as_text:e.Variant_frequency_as_text,min:e.min,max:e.max,allowFiltering:!0,dataset:""}}function St(e){const t=e.map(n=>`${n.search}: ${n.constraint.split(",").map(i=>ft[i]).join(", ")}`).join("; ");return{parent:void 0,uuid:g(),id:"snp-variant",filterType:"snp",displayType:"any",snpValues:e,variableName:"Variant Filter",description:t,allowFiltering:!0,dataset:""}}class U{constructor(t){l(this,"root");l(this,"createGroup");this.root=t([],O.AND),this.createGroup=t}get hasOr(){const t=r=>this.isGroup(r)?r.operator===O.OR?!0:r.children.some(t):!1;return t(this.root)}isGroup(t){return t&&"children"in t}add(...t){t.forEach(r=>{r.parent=this.root,this.root.children.push(r)})}remove(...t){t.forEach(r=>{r.parent!==void 0&&(r.parent.children=r.parent.children.filter(n=>n!==r))}),this.pruneTree()}update(t,r){const n=t.parent;if(this.transferChildrenIfGroups(t,r),r.parent=n,n===void 0){if(!this.isGroup(r))throw new Error("Root must be a TreeGroup");this.root=r;return}const i=n.children.indexOf(t);i!==-1&&(n.children[i]=r)}pruneTree(){const t=r=>{this.isGroup(r)&&(r.children.forEach(t),r.children.length===1&&this.moveChildToGrandparent(r.children[0]),r.children.length===0&&r.parent&&(r.parent.children=r.parent.children.filter(n=>n!==r)))};this.root.children.forEach(t)}transferChildrenIfGroups(t,r){!this.isGroup(t)||!this.isGroup(r)||r.children.length===0&&(r.children=t.children,r.children.forEach(n=>n.parent=r))}moveChildToGrandparent(t){if(t.parent===void 0||t.parent.parent===void 0)return;const r=t.parent.children.length,n=t.parent.parent.children.indexOf(t.parent);if(n<0)throw new Error("Tree structure is malformed: parent not found in grandparent's children");t.parent.children=t.parent.children.filter(i=>i!==t),t.parent.parent.children.splice(n,r===1?1:0,t),t.parent=t.parent.parent}newOrGroup(t,r){if(t.parent===void 0||r.parent===void 0||t.parent!==r.parent)return;const n=t.parent,i=this.createGroup([t,r],O.OR),a=n.children.indexOf(t),o=n.children.indexOf(r);n.children.splice(Math.max(a,o),1),n.children.splice(Math.min(a,o),1,i),i.parent=n,t.parent=i,r.parent=i}splitOrCollapseOrGroup(t,r){if(!(t.parent===void 0||r.parent===void 0)){if(t.parent.children.length===2)this.moveChildToGrandparent(t),this.moveChildToGrandparent(r);else if(t.parent.children.length>2){const n=t.parent.children.indexOf(t),i=r.parent.children.indexOf(r),a=r.parent.children.slice(i),o=this.createGroup(a,O.OR);if(a.forEach(s=>s.parent=o),t.parent.parent){const s=t.parent.parent.children.indexOf(t.parent);t.parent.parent.children.splice(s+1,0,o),t.parent.children=t.parent.children.slice(0,n+1)}o.parent=t.parent.parent}}}mergeOrGroups(t,r){if(t.parent===void 0||r.parent===void 0||t.parent!==r.parent)return;t.children.push(...r.children||[]),r.children.forEach(a=>a.parent=t);const n=t.parent,i=n.children.indexOf(r);i>=0&&n.children.splice(i,1)}mergeNodeIntoOrGroup(t,r){const[n,i]=this.isGroup(t)?[t,r]:[r,t];if(i.parent===void 0||n.parent===void 0)return;const a=i.parent.children.indexOf(i),o=i.parent.children.indexOf(n),s=a>o?n.children.length:0;n.children.splice(s,0,i),i.parent.children=i.parent.children.filter(d=>d!==i),i.parent=n}reorderNodes(t,r){if(!t||!r)throw new Error("Invalid nodes");if(t.parent===void 0||r.parent===void 0)throw new Error("Invalid parents");const n=t.parent,i=n.children.findIndex(o=>"uuid"in o&&o.uuid===t.uuid),a=n.children.findIndex(o=>"uuid"in o&&o.uuid===r.uuid);i===-1||a===-1||(n.children.splice(i,1),n.children.splice(a,0,t),t.parent=n,r.parent=n)}addNodeToGroup(t,r){var n,i;(i=t.parent)==null||i.children.splice(((n=t.parent)==null?void 0:n.children.indexOf(t))??-1,1),t.parent=r,r.children.push(t),this.pruneTree()}toggleOperator(t,r){t.parent===void 0||r.parent===void 0||t.parent===r.parent&&(!this.isGroup(t)&&!this.isGroup(r)?t.parent.operator===O.AND?this.newOrGroup(t,r):this.splitOrCollapseOrGroup(t,r):this.isGroup(t)&&this.isGroup(r)?this.mergeOrGroups(t,r):this.mergeNodeIntoOrGroup(t,r),this.pruneTree())}find(t){const r=n=>{if(t(n))return n;if(this.isGroup(n))for(const i of n.children){const a=r(i);if(a)return a}};return r(this.root)}get leafNodes(){const t=r=>this.isGroup(r)?r.children.flatMap(n=>t(n)):[r];return t(this.root)}get serialized(){const t=r=>{const{parent:n,children:i,...a}=r;return i?{children:i==null?void 0:i.map(t),...a}:a};try{return JSON.stringify(t(this.root))}catch(r){throw new Error(`Error serializing tree: ${r}`)}}static deserialize(t,r){const n=new U(r),i=(a,o)=>{n.isGroup(a)&&a.children.forEach(s=>i(s,a)),a.parent=o};try{const a=JSON.parse(t);return i(a),n.root=a,n}catch(a){throw a instanceof SyntaxError?new Error(`Invalid JSON: ${a.message}`):new Error(`Error deserializing tree: ${a}`)}}}const z=["snp","genomic"],J=(e,t)=>pt(e,t),v=I(ut()),h=I(gt()),q=G(h,e=>e.leafNodes),_t=G(v,e=>e&&e.length>0?e.some(t=>t.filterType==="genomic"):!1),Vt=G(q,e=>e&&e.length>0?e.some(t=>!t.allowFiltering):!1),Et=G([j,q],([e,t])=>t.length===0||!(e!=null&&e.queryScopes)?!1:t.some(r=>{var a;let n=r.dataset||"";return z.includes(r.filterType)&&(n="Gene_with_variant"),!((a=e==null?void 0:e.queryScopes)==null?void 0:a.some(o=>n.length>0&&o.includes(n)))})),Ut=G(h,e=>e.hasOr);function ht(){return sessionStorage.getItem("advancedFiltering")!==null?sessionStorage.getItem("advancedFiltering")==="true":!1}const Y=I(ht());Y.subscribe(e=>{sessionStorage.setItem("advancedFiltering",String(e))});function qt(){const e=u(h),t=r=>{if(e.isGroup(r)&&(r.children.forEach(t),r.operator===O.OR&&r.parent)){const n=[...r.children];if(n.length===2)e.toggleOperator(n[0],n[1]);else if(n.length>2){const i=r.parent,a=i.children.indexOf(r);n.forEach(o=>{o.parent=i}),i.children.splice(a,1,...n)}}};t(e.root),e.pruneTree(),e.root.uuid=g(),h.set(e)}const Nt=I(),Mt=I(),Dt=I();h.subscribe(e=>{sessionStorage.setItem("filterTree",e.serialized)});v.subscribe(e=>{sessionStorage.setItem("genomicFilters",JSON.stringify(e))});function ut(){return sessionStorage.getItem("genomicFilters")?JSON.parse(sessionStorage.getItem("genomicFilters")||"[]").map(t=>({...t,uuid:K(t)})):[]}function gt(){const e=new U(J);if(sessionStorage.getItem("filterTree")){const t=sessionStorage.getItem("filterTree");return t?U.deserialize(t,J):e}return e}function zt(e,t){if(!u(Y))return;const r=u(h);r.toggleOperator(e,t),r.root.uuid=g(),h.set(r)}function Rt(e){if("filterType"in e&&z.includes(e.filterType)){const t=u(v).filter(r=>r.id!==e.id);e.uuid=K(e),t.push(e),v.set(t)}else{const t=u(h),r=t.find(n=>"id"in n&&n.id===e.id);r?t.update(r,e):t.add(e),t.root.uuid=g(),h.set(t)}}function Pt(e){const t=o=>"uuid"in o&&o.uuid===e,r=u(v);if(r.find(t)){v.set(r.filter(o=>!t(o)));return}const i=u(h),a=i.find(o=>t(o));a&&(i.remove(a),i.root.uuid=g(),h.set(i))}function Ht(){v.set([])}function Jt(){const e=i=>!i.allowFiltering,t=u(v);v.set(t.filter(i=>!e(i)));const r=u(h),n=r.leafNodes.filter(i=>e(i));r.remove(...n),r.root.uuid=g(),h.set(r)}function jt(){const e=u(j),t=u(q);if(!e||t.length===0)return;const r=o=>{var c;let s=o.dataset||"";return z.includes(o.filterType)&&(s="Gene_with_variant"),(c=e.queryScopes)==null?void 0:c.some(f=>s.length>0&&f.includes(s))},n=u(v);v.set(n.filter(o=>r(o)));const i=u(h),a=i.leafNodes.filter(o=>!r(o));i.remove(...a),i.root.uuid=g(),h.set(i)}function Lt(){v.set([]);const e=u(h);e.root.children=[],e.root.uuid=g(),h.set(e)}function kt(e){return[...u(q),...u(v)].filter(t=>t.filterType===e)}export{H as A,Ht as B,Jt as C,Et as D,Vt as E,dt as G,lt as O,Ft as Q,Y as a,Ot as b,h as c,Ct as d,St as e,q as f,v as g,_t as h,Tt as i,Rt as j,Gt as k,It as l,yt as m,ft as n,kt as o,g as p,Lt as q,Pt as r,Nt as s,Mt as t,O as u,zt as v,qt as w,Ut as x,Dt as y,jt as z};
