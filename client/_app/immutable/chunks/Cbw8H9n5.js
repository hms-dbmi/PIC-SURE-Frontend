import{w,d as T,g as m}from"./zOfZnRfh.js";import{e as A}from"./BPudexzz.js";import{r as d,P as O,f as P,B as h}from"./CukpoKTN.js";import{p as S}from"./LJvazNn0.js";import{r as u}from"./CseAM1pm.js";const E="Bearer ";async function g({method:e,path:t,data:o,headers:n}){const s={method:e,headers:{}};o&&(s.headers["Content-Type"]="application/json",s.body=typeof o=="string"?o:JSON.stringify(o)),n&&(s.headers={...s.headers,...n});{const a=localStorage.getItem("token");a&&(s.headers.Authorization=`${E}${a}`,s.headers["request-source"]="Authorized"),u(S).url.pathname.includes("/discover")&&(s.headers["request-source"]="Open")}const c=await fetch(`${window.location.origin}/${t}`,s);return await R(c)}function p(e,t){return g({method:"GET",path:e,headers:t})}function G(e,t){return g({method:"DELETE",path:e,headers:t})}function $(e,t,o){return g({method:"POST",path:e,data:t,headers:o})}function H(e,t,o){return g({method:"PUT",path:e,data:t,headers:o})}async function R(e){if(e.ok||e.status===422){if(b(e),(e.headers.get("Content-Type")||"").includes("application/octet-stream"))return await e.arrayBuffer();const o=await e.text();try{return JSON.parse(o)}catch{return o}}else if(e.status===401){sessionStorage.setItem("logout-reason","Your session has timed out. Please log in."),k(void 0,!0);return}else e.status===403&&(sessionStorage.removeItem("logout-reason"),sessionStorage.removeItem("filters"),k(void 0,!1));throw A(e.status,await e.text())}function b(e){let t=e.headers.get("Authorization");t&&(t=t.replace(E,""),B(t))}const i=w(D());i.subscribe(e=>{{v();const t={...e};t.token=void 0,localStorage.setItem("user",JSON.stringify(t))}});function C(e,t){const o=w(!!localStorage.getItem(e));return window.addEventListener("storage",n=>{n.key===e&&o.set(!!n.newValue)}),o}function L(e){localStorage.setItem("token",e),l.set(!!l)}function y(){localStorage.removeItem("token"),l.set(!1)}const l=C("token"),N=T(l,e=>e);function D(){if(localStorage.getItem("user")){v();try{const e=JSON.parse(localStorage.getItem("user")||"{}");return!e||Object.keys(e).length===0?{}:(console.log("Restored user from local storage: ",e),e)}catch(e){return console.error("Error reading user from local storage:  "+e),{}}}return{}}function M(){return!!localStorage.getItem("token")}function v(){{const e=localStorage.getItem("token");e&&J(e)&&(console.log("Clearing expired token from local storage."),y())}}const Y=T([i,N],([e,t])=>{const o=(e==null?void 0:e.privileges)||[];if(o.length===0||!t)return d.filter(a=>!a.privilege);function n(a){return a.filter(r=>r.feature?!!P[r.feature]:!0).map(r=>r.children?{...r,children:n(r.children)}:r)}const s=n(d);if(o.includes(O.SUPER))return s;function c(a){return a.filter(r=>r.privilege?r.privilege.some(x=>o.includes(x)):!0).map(r=>r.children?{...r,children:c(r.children)}:r)}return c(s)});async function _(e,t=!1){{const o=await p(`psama/user/me${t?"?hasToken":""}`);if(o.privileges&&o.token){for(const n of o.privileges)if(n.includes(h.PRIV_MANAGED)){o.privileges.push(h.AUTHORIZED_ACCESS);break}}i.set({...u(i),...o})}}async function Z(){const e=await p("psama/user/me/refresh_long_term_token").then(t=>{if(!t.userLongTermToken)throw new Error("No user token was returned.");return t.userLongTermToken});i.set({...u(i),token:e})}async function B(e){e&&(L(e),await _(!0,!1))}async function k(e,t=!1){localStorage.getItem("token")&&(p("/psama/logout").catch(n=>{console.error("Error logging out: "+n)}),y()),e?e.logout().then(o=>{typeof o=="string"?(i.set({}),location.replace(o)):(console.error("Error logging out: "+o),f(t))}).catch(o=>{console.error("Error logging out: "+o),f(t)}):f(t)}function f(e){i.set({}),e?m(`/login?redirectTo=${encodeURIComponent(u(S).url.pathname)}`):m("/login")}function J(e){try{return I(e)<new Date().getTime()}catch(t){return console.error("Error checking token expiration: "+t),!0}}function I(e){if(!e)throw new Error("No token provided.");try{return JSON.parse(atob(e.split(".")[1])).exp*1e3}catch(t){throw new Error("Error parsing token: "+t)}}function F(e){try{return new Date(I(e))}catch(t){console.error("Error getting token expiration as date: "+t);return}}export{H as a,_ as b,I as c,G as d,F as e,M as f,p as g,N as h,J as i,Y as j,k,B as l,$ as p,Z as r,i as u};
