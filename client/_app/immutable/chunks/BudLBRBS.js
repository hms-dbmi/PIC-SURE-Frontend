import"./Bzak7iHL.js";import{p as ae,h as S,i as A,f as E,d as c,l as v,n as R,j as N,t as f,k as r,b,s as n,r as u,c as te,a as re,u as se,m as le}from"./DhSNEPDw.js";import{s as C,e as ie}from"./DVtHS8ol.js";import{i as O}from"./BG76zvuN.js";import{e as B,i as F}from"./ByI6iVq5.js";import{r as q,s as z,e as G,f as oe,d as H}from"./aV0zye_u.js";import{b as ne,a as de}from"./DPXw0ygh.js";import{p as ce}from"./DpjY2ypC.js";import{g as ue}from"./Dkbkn6HV.js";import{t as D}from"./M2p3ZkHt.js";import{S as me}from"./D6DWNZYd.js";import{u as pe,g as ve,a as fe}from"./BjI_kDbH.js";import{g as be}from"./CjgU9VCR.js";import{g as _e}from"./z6JXWtIA.js";import{g as ge}from"./DB-Id7Bq.js";import{E as he}from"./CQQkdEes.js";var ye=E('<label class="label"><span>UUID:</span> <input type="text" class="input" disabled/></label> <label class="label"><span>Subject:</span> <input type="text" class="input" disabled/></label>',1),xe=E("<option> </option>"),$e=E('<label class="flex items-center space-x-2"><input class="checkbox" type="checkbox"/> <div> </div></label>'),ke=E('<form><fieldset data-testid="user-form" class="grid gap-4 my-3"><!> <!> <label><span>Email:</span> <input type="email" class="input" required minlength="1" maxlength="255"/></label> <label><span>Connection:</span> <select required><option disabled>none</option><!></select></label> <fieldset data-testid="privilege-checkboxes"><legend class="required">Roles:</legend> <!></fieldset> <!> <div class="mt-2"><button type="submit" class="btn preset-tonal-primary border border-primary-500 hover:preset-filled-primary-500">Save</button> <a href="/admin/users" class="btn preset-tonal-secondary border border-secondary-500 hover:preset-filled-secondary-500">Cancel</a></div></fieldset></form>');function Oe(K,_){ae(_,!0);let e=ce(_,"user",3,void 0),m=S(A(e()&&e().email?e().email:"")),y=S(A(e()&&e().connection?e().connection:"")),g=S(A(e()?e().active:!0)),P=A(_.roleList.map(([t,a])=>({uuid:a,checked:e()?e().roles.includes(a):!1}))),h=S("");async function Q(t){var o;t.preventDefault();const a=P.filter(l=>l.checked);if(a.length===0){v(h,"At least one role must be selected.");return}else v(h,"");const s=JSON.parse(((o=e())==null?void 0:o.generalMetadata)||'{"email":""}');s.email=r(m);let i={email:r(m),connection:await be(r(y)),generalMetadata:JSON.stringify(s),active:r(g),roles:await Promise.all(a.map(l=>_e(l.uuid).then(d=>({...d,privileges:d.privileges.map(p=>ge(p))}))))};try{if(e())await pe({...i,uuid:e().uuid});else{if(await ve(r(m),r(y))){D.error({title:"Cannot add a user and connection pair that already exists."});return}await fe(i)}D.success({title:`Successfully saved ${e()?"":"new "}user '${r(m)}'`}),ue("/admin/users")}catch(l){console.error(l),D.error({title:`An error occured while saving ${e()?"":"new "}user '${r(m)}'`})}}var x=ke(),I=c(x),J=c(I);me(J,{name:"Active",controlActive:"bg-success-500",label:"Status",get checked(){return r(g)},onCheckedChange:()=>v(g,!r(g)),children:(t,a)=>{R();var s=N();f(()=>C(s,r(g)?"Active":"Inactive")),b(t,s)},$$slots:{default:!0}});var L=n(J,2);{var T=t=>{var a=ye(),s=re(a),i=n(c(s),2);q(i),u(s);var o=n(s,2),l=n(c(o),2);q(l),u(o),f(()=>{var d,p;H(i,(d=e())==null?void 0:d.uuid),H(l,(p=e())==null?void 0:p.subject)}),b(t,a)};O(L,t=>{var a;(a=e())!=null&&a.uuid&&t(T)})}var $=n(L,2),j=n(c($),2);q(j),u($);var k=n($,2),U=n(c(k),2),w=c(U);w.value=w.__value=!0;var V=n(w);B(V,17,()=>_.connections,F,(t,a,s,i)=>{var o=xe(),l=c(o,!0);u(o);var d={};f(()=>{G(o,e()&&e().connection===r(a).uuid),C(l,r(a).label),d!==(d=r(a).uuid)&&(o.value=(o.__value=r(a).uuid)??"")}),b(t,o)}),u(U),u(k);var M=n(k,2),W=n(c(M),2);B(W,17,()=>_.roleList,F,(t,a,s)=>{var i=se(()=>le(r(a),1));let o=()=>r(i)[0];var l=$e(),d=c(l);q(d);var p=n(d,2),Z=c(p,!0);u(p),u(l),f(()=>C(Z,o())),de(d,()=>P[s].checked,ee=>P[s].checked=ee),b(t,l)}),u(M);var X=n(M,2);{var Y=t=>{he(t,{"data-testid":"validation-error",onclose:()=>v(h,""),children:(a,s)=>{R();var i=N();f(()=>C(i,r(h))),b(a,i)},$$slots:{default:!0}})};O(X,t=>{r(h)&&t(Y)})}R(2),u(I),u(x),f(()=>{var t,a,s,i;z($,1,`label ${((t=e())==null?void 0:t.email)??"required"??""}`),j.disabled=!!((a=e())!=null&&a.email),z(k,1,`label ${((s=e())==null?void 0:s.email)??"required"??""}`),U.disabled=!!((i=e())!=null&&i.connection),G(w,!e()||!e().connection)}),ie("submit",x,Q),ne(j,()=>r(m),t=>v(m,t)),oe(U,()=>r(y),t=>v(y,t)),b(K,x),te()}export{Oe as U};
