import{w,d as E,g as f}from"./entry.Df3FuYeh.js";import{e as S}from"./index.C5Uz_1jj.js";import{r as p,P as v,f as I,B as m,a as x}from"./configuration.LanpiT2M.js";import{p as h}from"./stores.CPF93CS5.js";import{r as c}from"./scheduler.bui7uCNy.js";const d="Bearer ";async function l({method:e,path:r,data:t,headers:a}){const n={method:e,headers:{}};t&&(n.headers["Content-Type"]="application/json",n.body=typeof t=="string"?t:JSON.stringify(t)),a&&(n.headers={...n.headers,...a});{const o=localStorage.getItem("token");o&&(n.headers.Authorization=`${d}${o}`,n.headers["request-source"]="Authorized"),c(h).url.pathname.includes("/discover")&&(n.headers["request-source"]="Open")}const i=await fetch(`${window.location.origin}/${r}`,n);return await A(i)}function u(e,r){return l({method:"GET",path:e,headers:r})}function U(e,r){return l({method:"DELETE",path:e,headers:r})}function z(e,r,t){return l({method:"POST",path:e,data:r,headers:t})}function j(e,r,t){return l({method:"PUT",path:e,data:r,headers:t})}async function A(e){if(e.ok||e.status===422){O(e);const r=await e.text();try{return JSON.parse(r)}catch{return r}}else if(e.status===401){sessionStorage.setItem("logout-reason","Your session has timed out. Please log in."),q(void 0,!0);return}throw S(e.status,await e.text())}function O(e){let r=e.headers.get("Authorization");r&&(r=r.replace(d,""),b(r))}const s=w(N());s.subscribe(e=>{{k();const r={...e};r.token=void 0,localStorage.setItem("user",JSON.stringify(r))}});function N(){if(localStorage.getItem("user")){k();try{const e=JSON.parse(localStorage.getItem("user")||"{}");return!e||Object.keys(e).length===0?{}:(console.log("Restored user from local storage: ",e),e)}catch(e){return console.error("Error reading user from local storage:  "+e),{}}}return{}}function k(){{const e=localStorage.getItem("token");e&&C(e)&&(console.log("Clearing expired token from local storage."),localStorage.removeItem("token"))}}const G=E(s,e=>{const r=(e==null?void 0:e.privileges)||[];if(r.length===0)return p.filter(i=>!i.privilege);function t(i){return i.filter(o=>o.feature?!!I[o.feature]:!0).map(o=>o.children?{...o,children:t(o.children)}:o)}const a=t(p);if(r.includes(v.SUPER))return a;function n(i){return i.filter(o=>o.privilege?o.privilege.some(y=>r.includes(y)):!0).map(o=>o.children?{...o,children:n(o.children)}:o)}return n(a)});async function P(e,r=!1){{const t=await u(`psama/user/me${r?"?hasToken":""}`);if(t.privileges&&t.token){for(const a of t.privileges)if(a.includes(m.PRIV_MANAGED)){t.privileges.push(m.AUTHORIZED_ACCESS);break}}s.set({...c(s),...t})}}async function $(){const e=await u("psama/user/me/refresh_long_term_token").then(r=>{if(!r.userLongTermToken)throw new Error("No user token was returned.");return r.userLongTermToken});s.set({...c(s),token:e})}async function R(){try{const e=await u("psama/user/me/queryTemplate/"+x.application);return JSON.parse(e.queryTemplate)}catch(e){return console.error("Error parsing query template: "+e),{}}}async function b(e){if(e){localStorage.setItem("token",e),await P(!0,!1);{const r=await R();r&&s.set({...c(s),queryTemplate:r})}}}async function q(e,r=!1){localStorage.getItem("token")&&(u("/psama/logout").catch(a=>{console.error("Error logging out: "+a)}),localStorage.removeItem("token")),e?e.logout().then(t=>{typeof t=="string"?(s.set({}),location.replace(t)):(console.error("Error logging out: "+t),g(r))}).catch(t=>{console.error("Error logging out: "+t),g(r)}):g(r)}function g(e){s.set({}),e?f(`/login?redirectTo=${encodeURIComponent(c(h).url.pathname)}`):f("/login")}function C(e){try{return T(e)<new Date().getTime()}catch(r){return console.error("Error checking token expiration: "+r),!0}}function T(e){if(!e)throw new Error("No token provided.");try{return JSON.parse(atob(e.split(".")[1])).exp*1e3}catch(r){throw new Error("Error parsing token: "+r)}}function H(e){try{return new Date(T(e))}catch(r){console.error("Error getting token expiration as date: "+r);return}}export{j as a,P as b,T as c,U as d,H as e,G as f,u as g,q as h,C as i,b as l,z as p,$ as r,s as u};
