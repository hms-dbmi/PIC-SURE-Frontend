import{g as c,w as S,d as u}from"./DpyMT7OB.js";import{e as N}from"./CsbAvI7j.js";import{B as h,r as O,P as m,a as k,f as P}from"./BD7x6Jnt.js";import{g as T}from"./DNfOBMJV.js";import{p as w}from"./DjiALQWk.js";const E="Bearer ";async function g({method:e,path:t,data:r,headers:n}){const a={method:e,headers:{}};r&&(a.headers["Content-Type"]="application/json",a.body=typeof r=="string"?r:JSON.stringify(r)),n&&(a.headers={...a.headers,...n});{const i=localStorage.getItem("token");i&&(a.headers.Authorization=`${E}${i}`,a.headers["request-source"]="Authorized"),c(w).url.pathname.includes("/discover")&&(a.headers["request-source"]="Open")}const l=await fetch(`${window.location.origin}/${t}`,a);return await R(l)}function f(e,t){return g({method:"GET",path:e,headers:t})}function H(e,t){return g({method:"DELETE",path:e,headers:t})}function Q(e,t,r){return g({method:"POST",path:e,data:t,headers:r})}function Y(e,t,r){return g({method:"PUT",path:e,data:t,headers:r})}async function R(e){if(e.ok||e.status===422){if(b(e),(e.headers.get("Content-Type")||"").includes("application/octet-stream"))return await e.arrayBuffer();const r=await e.text();try{return JSON.parse(r)}catch{return r}}else if(e.status===401){sessionStorage.setItem("logout-reason","Your session has timed out. Please log in."),y(void 0,!0);return}else e.status===403&&(sessionStorage.removeItem("logout-reason"),sessionStorage.removeItem("filters"),y(void 0,!1));N(e.status,await e.text())}function b(e){let t=e.headers.get("Authorization");t&&(t=t.replace(E,""),B(t))}function q(e,t){const r=S(!!localStorage.getItem(e));return window.addEventListener("storage",n=>{n.key===e&&r.set(!!n.newValue)}),r}const d=q("token"),s=S(L()),Z=u(s,e=>{var t;return(t=e==null?void 0:e.privileges)==null?void 0:t.includes(m.SUPER)}),F=u(s,e=>{var t;return(t=e==null?void 0:e.privileges)==null?void 0:t.includes(m.ADMIN)}),C=u(d,e=>e);s.subscribe(e=>{{I();const t={...e};t.token=void 0,localStorage.setItem("user",JSON.stringify(t))}});function D(e){localStorage.setItem("token",e),d.set(!0)}function v(){localStorage.removeItem("token"),d.set(!1)}function L(){if(localStorage.getItem("user")){I();try{const e=JSON.parse(localStorage.getItem("user")||"{}");return!e||Object.keys(e).length===0?{}:(console.log("Restored user from local storage: ",e),e)}catch(e){return console.error("Error reading user from local storage:  "+e),{}}}return{}}function K(){return!!localStorage.getItem("token")}function I(){{const e=localStorage.getItem("token");e&&_(e)&&(console.log("Clearing expired token from local storage."),v())}}const W=u([s,C],([e,t])=>{const r=(e==null?void 0:e.privileges)||[];if(r.length===0||!t)return k.filter(i=>!i.privilege);function n(i){return i.filter(o=>o.feature?!!P[o.feature]:!0).map(o=>o.children?{...o,children:n(o.children)}:o)}const a=n(k);if(r.includes(m.SUPER))return a;function l(i){return i.filter(o=>o.privilege?o.privilege.some(x=>r.includes(x)):!0).map(o=>o.children?{...o,children:l(o.children)}:o)}return l(a)});async function J(e,t=!1){{const r=await f(`psama/user/me${t?"?hasToken":""}`);if(r.privileges&&r.token){for(const n of r.privileges)if(n.includes(h.PRIV_MANAGED)){r.privileges.push(h.AUTHORIZED_ACCESS);break}}s.set({...c(s),...r})}}function X(){return f("psama/user/me/refresh_long_term_token").then(e=>{if(!e.userLongTermToken)throw new Error("No user token was returned.");return s.set({...c(s),token:e.userLongTermToken}),e.userLongTermToken})}async function U(){try{const e=await f("psama/user/me/queryTemplate/"+O.application);return JSON.parse(e.queryTemplate)}catch(e){return console.error("Error parsing query template: "+e),{}}}async function B(e){if(e){D(e),await J(!0,!1);{const t=await U();t&&s.set({...c(s),queryTemplate:t})}}}async function y(e,t=!1){localStorage.getItem("token")&&(f("/psama/logout").catch(n=>{console.error("Error logging out: "+n)}),v()),e?e.logout().then(r=>{typeof r=="string"?(s.set({}),location.replace(r)):(console.error("Error logging out: "+r),p(t))}).catch(r=>{console.error("Error logging out: "+r),p(t)}):p(t)}function p(e){s.set({}),e?T(`/login?redirectTo=${encodeURIComponent(c(w).url.pathname)}`):T("/login")}function _(e){try{return A(e)<new Date().getTime()}catch(t){return console.error("Error checking token expiration: "+t),!0}}function A(e){if(!e)throw new Error("No token provided.");try{return JSON.parse(atob(e.split(".")[1])).exp*1e3}catch(t){throw new Error("Error parsing token: "+t)}}function $(e){try{return new Date(A(e))}catch(t){console.error("Error getting token expiration as date: "+t);return}}export{Z as a,F as b,Q as c,H as d,$ as e,J as f,f as g,A as h,_ as i,K as j,W as k,B as l,y as m,C as n,Y as p,X as r,s as u};
