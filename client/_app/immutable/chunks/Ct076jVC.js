import{w as T,d as y,g as m}from"./D9QhBFw8.js";import{e as A}from"./BbQdfDK7.js";import{r as d,P as O,f as N,B as h,a as P}from"./Do7xJ0Gi.js";import{p as w}from"./Bx_3jGoJ.js";import{r as c}from"./CJ6ziB5E.js";const S="Bearer ";async function g({method:e,path:t,data:r,headers:n}){const s={method:e,headers:{}};r&&(s.headers["Content-Type"]="application/json",s.body=typeof r=="string"?r:JSON.stringify(r)),n&&(s.headers={...s.headers,...n});{const i=localStorage.getItem("token");i&&(s.headers.Authorization=`${S}${i}`,s.headers["request-source"]="Authorized"),c(w).url.pathname.includes("/discover")&&(s.headers["request-source"]="Open")}const l=await fetch(`${window.location.origin}/${t}`,s);return await R(l)}function f(e,t){return g({method:"GET",path:e,headers:t})}function H(e,t){return g({method:"DELETE",path:e,headers:t})}function M(e,t,r){return g({method:"POST",path:e,data:t,headers:r})}function Q(e,t,r){return g({method:"PUT",path:e,data:t,headers:r})}async function R(e){if(e.ok||e.status===422){if(b(e),(e.headers.get("Content-Type")||"").includes("application/octet-stream"))return await e.arrayBuffer();const r=await e.text();try{return JSON.parse(r)}catch{return r}}else if(e.status===401){sessionStorage.setItem("logout-reason","Your session has timed out. Please log in."),k(void 0,!0);return}else e.status===403&&(sessionStorage.removeItem("logout-reason"),sessionStorage.removeItem("filters"),k(void 0,!1));throw A(e.status,await e.text())}function b(e){let t=e.headers.get("Authorization");t&&(t=t.replace(S,""),B(t))}const a=T(D());a.subscribe(e=>{{v();const t={...e};t.token=void 0,localStorage.setItem("user",JSON.stringify(t))}});function q(e,t){const r=T(!!localStorage.getItem(e));return window.addEventListener("storage",n=>{n.key===e&&r.set(!!n.newValue)}),r}function C(e){localStorage.setItem("token",e),u.set(!!u)}function E(){localStorage.removeItem("token"),u.set(!1)}const u=q("token"),L=y(u,e=>e);function D(){if(localStorage.getItem("user")){v();try{const e=JSON.parse(localStorage.getItem("user")||"{}");return!e||Object.keys(e).length===0?{}:(console.log("Restored user from local storage: ",e),e)}catch(e){return console.error("Error reading user from local storage:  "+e),{}}}return{}}function Y(){return!!localStorage.getItem("token")}function v(){{const e=localStorage.getItem("token");e&&U(e)&&(console.log("Clearing expired token from local storage."),E())}}const Z=y([a,L],([e,t])=>{const r=(e==null?void 0:e.privileges)||[];if(r.length===0||!t)return d.filter(i=>!i.privilege);function n(i){return i.filter(o=>o.feature?!!N[o.feature]:!0).map(o=>o.children?{...o,children:n(o.children)}:o)}const s=n(d);if(r.includes(O.SUPER))return s;function l(i){return i.filter(o=>o.privilege?o.privilege.some(x=>r.includes(x)):!0).map(o=>o.children?{...o,children:l(o.children)}:o)}return l(s)});async function _(e,t=!1){{const r=await f(`psama/user/me${t?"?hasToken":""}`);if(r.privileges&&r.token){for(const n of r.privileges)if(n.includes(h.PRIV_MANAGED)){r.privileges.push(h.AUTHORIZED_ACCESS);break}}a.set({...c(a),...r})}}async function F(){const e=await f("psama/user/me/refresh_long_term_token").then(t=>{if(!t.userLongTermToken)throw new Error("No user token was returned.");return t.userLongTermToken});a.set({...c(a),token:e})}async function J(){try{const e=await f("psama/user/me/queryTemplate/"+P.application);return JSON.parse(e.queryTemplate)}catch(e){return console.error("Error parsing query template: "+e),{}}}async function B(e){if(e){C(e),await _(!0,!1);{const t=await J();t&&a.set({...c(a),queryTemplate:t})}}}async function k(e,t=!1){localStorage.getItem("token")&&(f("/psama/logout").catch(n=>{console.error("Error logging out: "+n)}),E()),e?e.logout().then(r=>{typeof r=="string"?(a.set({}),location.replace(r)):(console.error("Error logging out: "+r),p(t))}).catch(r=>{console.error("Error logging out: "+r),p(t)}):p(t)}function p(e){a.set({}),e?m(`/login?redirectTo=${encodeURIComponent(c(w).url.pathname)}`):m("/login")}function U(e){try{return I(e)<new Date().getTime()}catch(t){return console.error("Error checking token expiration: "+t),!0}}function I(e){if(!e)throw new Error("No token provided.");try{return JSON.parse(atob(e.split(".")[1])).exp*1e3}catch(t){throw new Error("Error parsing token: "+t)}}function K(e){try{return new Date(I(e))}catch(t){console.error("Error getting token expiration as date: "+t);return}}export{Q as a,_ as b,I as c,H as d,K as e,Y as f,f as g,L as h,U as i,Z as j,k,B as l,M as p,F as r,a as u};
