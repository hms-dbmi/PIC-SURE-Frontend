{"version":3,"file":"ResultStore-bQgsQzg8.js","sources":["../../../.svelte-kit/adapter-node/chunks/ResultStore.js"],"sourcesContent":["import { w as writable, i as get } from \"./exports.js\";\nimport { l as loadResources, f as loading, h as isToastShowing, t as toaster } from \"./User.js\";\nimport { b as branding } from \"./configuration.js\";\nimport { g as getResultList, S as StatPromise, c as countResult } from \"./StatBuilder.js\";\nimport { g as genomicFilters, f as filters, a as advancedFilteringEnabled } from \"./Filter.js\";\nimport { s as searchTerm, a as selectedFacets } from \"./Dictionary.js\";\nconst CACHE_MAX_ENTRIES = 100;\nconst requestCache = /* @__PURE__ */ new Map();\nconst hasNonZeroResult = writable(false);\nconst resultCounts = writable([]);\nwritable(Promise.resolve());\nconst countsLoading = writable(false);\nconst totalParticipants = writable(0);\nasync function loadPatientCount(isOpenAccess) {\n  loadResources();\n  try {\n    if (requestCache.size >= CACHE_MAX_ENTRIES) {\n      requestCache.clear();\n    }\n    const cacheKey = JSON.stringify([\n      isOpenAccess,\n      get(searchTerm),\n      get(selectedFacets).map((facet) => facet.name),\n      get(genomicFilters).map(({ uuid }) => uuid),\n      // if operator changes we need to redo query\n      get(filters).map(({ uuid, parent }) => uuid + parent?.operator),\n      // if advanced filtering toggle changes, query version changes (V2 vs V3)\n      get(advancedFilteringEnabled)\n    ]);\n    if (requestCache.has(cacheKey)) {\n      resultCounts.set(requestCache.get(cacheKey));\n      countsLoading.set(false);\n      return;\n    }\n    await get(loading);\n    const resultStats = getResultList(isOpenAccess, branding?.results?.stats || []);\n    resultCounts.set(resultStats);\n    countsLoading.set(true);\n    Promise.allSettled(resultStats.flatMap(StatPromise.list).map(({ promise }) => promise)).then(\n      (results) => {\n        if (!results.some(StatPromise.rejected)) {\n          requestCache.set(cacheKey, resultStats);\n        }\n        hasNonZeroResult.set(\n          results.some(\n            (result) => StatPromise.fullfiled(result) && `${countResult([result.value])}` !== \"0\"\n          )\n        );\n        countsLoading.set(false);\n      }\n    );\n    const totalCount = resultStats.find((count) => count.key === branding?.results?.totalStatKey);\n    if (totalCount) {\n      Promise.allSettled(StatPromise.list(totalCount).map(({ promise }) => promise)).then(\n        (results) => {\n          const values = results.filter(StatPromise.fullfiled).map(({ value }) => value);\n          totalParticipants.set(countResult(values, false));\n        }\n      );\n    }\n  } catch (error) {\n    console.error(error);\n    countsLoading.set(false);\n    if (!isToastShowing(\"query-error\")) {\n      toaster.error({\n        id: \"query-error\",\n        duration: 4e3,\n        title: \"An error occured while loading patient counts. If this problem persists, please contact an administrator.\",\n        closable: true\n      });\n    }\n  }\n}\nexport {\n  countsLoading as c,\n  hasNonZeroResult as h,\n  loadPatientCount as l,\n  resultCounts as r,\n  totalParticipants as t\n};\n"],"names":[],"mappings":"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"}