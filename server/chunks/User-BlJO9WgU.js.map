{"version":3,"file":"User-BlJO9WgU.js","sources":["../../../.svelte-kit/adapter-node/chunks/User.js"],"sourcesContent":["import { d as derived, w as writable } from \"./index2.js\";\nimport { e as error } from \"./index.js\";\nimport { a as routes, P as PicsurePrivileges, f as features, B as BDCPrivileges } from \"./configuration.js\";\nimport { g as goto } from \"./client.js\";\nimport { p as page } from \"./stores3.js\";\nimport { g as get_store_value } from \"./lifecycle.js\";\nconst BEARER = \"Bearer \";\nasync function send({\n  method,\n  path,\n  data,\n  headers\n}) {\n  const opts = {\n    method,\n    headers: {}\n  };\n  if (data) {\n    opts.headers[\"Content-Type\"] = \"application/json\";\n    opts.body = typeof data === \"string\" ? data : JSON.stringify(data);\n  }\n  if (headers) {\n    opts.headers = { ...opts.headers, ...headers };\n  }\n  const res = await fetch(`${window.location.origin}/${path}`, opts);\n  return await handleResponse(res);\n}\nfunction get(path, headers) {\n  return send({ method: \"GET\", path, headers });\n}\nfunction del(path, headers) {\n  return send({ method: \"DELETE\", path, headers });\n}\nfunction post(path, data, headers) {\n  return send({ method: \"POST\", path, data, headers });\n}\nfunction put(path, data, headers) {\n  return send({ method: \"PUT\", path, data, headers });\n}\nasync function handleResponse(res) {\n  if (res.ok || res.status === 422) {\n    refreshToken(res);\n    const text = await res.text();\n    try {\n      return JSON.parse(text);\n    } catch (e) {\n      return text;\n    }\n  } else if (res.status === 401) {\n    logout(void 0, true);\n    return;\n  }\n  throw error(res.status, await res.text());\n}\nfunction refreshToken(res) {\n  let newAuthToken = res.headers.get(\"Authorization\");\n  if (newAuthToken) {\n    newAuthToken = newAuthToken.replace(BEARER, \"\");\n    login();\n  }\n}\nconst user = writable(restoreUser());\nuser.subscribe((user2) => {\n});\nfunction restoreUser() {\n  return {};\n}\nconst userRoutes = derived(user, ($user) => {\n  const userPrivileges = $user?.privileges || [];\n  if (userPrivileges.length === 0) {\n    return routes.filter((route) => !route.privilege);\n  }\n  function featureRoutes(routeList) {\n    return routeList.filter((route) => route.feature ? !!features[route.feature] : true).map(\n      (route) => route.children ? { ...route, children: featureRoutes(route.children) } : route\n    );\n  }\n  const featured = featureRoutes(routes);\n  if (userPrivileges.includes(PicsurePrivileges.SUPER)) {\n    return featured;\n  }\n  function allowedRoutes(routeList) {\n    return routeList.filter(\n      (route) => route.privilege ? route.privilege.some((priv) => userPrivileges.includes(priv)) : true\n    ).map(\n      (route) => route.children ? { ...route, children: allowedRoutes(route.children) } : route\n    );\n  }\n  return allowedRoutes(featured);\n});\nasync function getUser(force, hasToken = false) {\n  {\n    const res = await get(`psama/user/me${hasToken ? \"?hasToken\" : \"\"}`);\n    if (res.privileges && res.token) {\n      for (const privilege of res.privileges) {\n        if (privilege.includes(BDCPrivileges.PRIV_MANAGED)) {\n          res.privileges.push(BDCPrivileges.AUTHORIZED_ACCESS);\n          break;\n        }\n      }\n    }\n    user.set({ ...get_store_value(user), ...res });\n  }\n}\nasync function login(token) {\n}\nasync function logout(authProvider, redirect = false) {\n  {\n    handleLogout(redirect);\n  }\n}\nfunction handleLogout(redirect) {\n  user.set({});\n  if (redirect) {\n    goto(`/login?redirectTo=${encodeURIComponent(get_store_value(page).url.pathname)}`);\n  } else {\n    goto();\n  }\n}\nfunction getTokenExpiration(token) {\n  if (!token) {\n    throw new Error(\"No token provided.\");\n  }\n  try {\n    return JSON.parse(atob(token.split(\".\")[1])).exp * 1e3;\n  } catch (error2) {\n    throw new Error(\"Error parsing token: \" + error2);\n  }\n}\nfunction getTokenExpirationAsDate(token) {\n  try {\n    return new Date(getTokenExpiration(token));\n  } catch (error2) {\n    console.error(\"Error getting token expiration as date: \" + error2);\n    return void 0;\n  }\n}\nexport {\n  userRoutes as a,\n  put as b,\n  getTokenExpirationAsDate as c,\n  del as d,\n  getUser as e,\n  getTokenExpiration as f,\n  get as g,\n  post as p,\n  user as u\n};\n"],"names":[],"mappings":";;;;;;;AAMA,MAAM,MAAM,GAAG,SAAS,CAAC;AACzB,eAAe,IAAI,CAAC;AACpB,EAAE,MAAM;AACR,EAAE,IAAI;AACN,EAAE,IAAI;AACN,EAAE,OAAO;AACT,CAAC,EAAE;AACH,EAAE,MAAM,IAAI,GAAG;AACf,IAAI,MAAM;AACV,IAAI,OAAO,EAAE,EAAE;AACf,GAAG,CAAC;AACJ,EAAE,IAAI,IAAI,EAAE;AACZ,IAAI,IAAI,CAAC,OAAO,CAAC,cAAc,CAAC,GAAG,kBAAkB,CAAC;AACtD,IAAI,IAAI,CAAC,IAAI,GAAG,OAAO,IAAI,KAAK,QAAQ,GAAG,IAAI,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;AACvE,GAAG;AACH,EAAE,IAAI,OAAO,EAAE;AACf,IAAI,IAAI,CAAC,OAAO,GAAG,EAAE,GAAG,IAAI,CAAC,OAAO,EAAE,GAAG,OAAO,EAAE,CAAC;AACnD,GAAG;AACH,EAAE,MAAM,GAAG,GAAG,MAAM,KAAK,CAAC,CAAC,EAAE,MAAM,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC;AACrE,EAAE,OAAO,MAAM,cAAc,CAAC,GAAG,CAAC,CAAC;AACnC,CAAC;AACD,SAAS,GAAG,CAAC,IAAI,EAAE,OAAO,EAAE;AAC5B,EAAE,OAAO,IAAI,CAAC,EAAE,MAAM,EAAE,KAAK,EAAE,IAAI,EAAE,OAAO,EAAE,CAAC,CAAC;AAChD,CAAC;AACD,SAAS,GAAG,CAAC,IAAI,EAAE,OAAO,EAAE;AAC5B,EAAE,OAAO,IAAI,CAAC,EAAE,MAAM,EAAE,QAAQ,EAAE,IAAI,EAAE,OAAO,EAAE,CAAC,CAAC;AACnD,CAAC;AACD,SAAS,IAAI,CAAC,IAAI,EAAE,IAAI,EAAE,OAAO,EAAE;AACnC,EAAE,OAAO,IAAI,CAAC,EAAE,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,OAAO,EAAE,CAAC,CAAC;AACvD,CAAC;AACD,SAAS,GAAG,CAAC,IAAI,EAAE,IAAI,EAAE,OAAO,EAAE;AAClC,EAAE,OAAO,IAAI,CAAC,EAAE,MAAM,EAAE,KAAK,EAAE,IAAI,EAAE,IAAI,EAAE,OAAO,EAAE,CAAC,CAAC;AACtD,CAAC;AACD,eAAe,cAAc,CAAC,GAAG,EAAE;AACnC,EAAE,IAAI,GAAG,CAAC,EAAE,IAAI,GAAG,CAAC,MAAM,KAAK,GAAG,EAAE;AACpC,IAAI,YAAY,CAAC,GAAG,CAAC,CAAC;AACtB,IAAI,MAAM,IAAI,GAAG,MAAM,GAAG,CAAC,IAAI,EAAE,CAAC;AAClC,IAAI,IAAI;AACR,MAAM,OAAO,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;AAC9B,KAAK,CAAC,OAAO,CAAC,EAAE;AAChB,MAAM,OAAO,IAAI,CAAC;AAClB,KAAK;AACL,GAAG,MAAM,IAAI,GAAG,CAAC,MAAM,KAAK,GAAG,EAAE;AACjC,IAAI,MAAM,CAAC,KAAK,CAAC,EAAE,IAAI,CAAC,CAAC;AACzB,IAAI,OAAO;AACX,GAAG;AACH,EAAE,MAAM,KAAK,CAAC,GAAG,CAAC,MAAM,EAAE,MAAM,GAAG,CAAC,IAAI,EAAE,CAAC,CAAC;AAC5C,CAAC;AACD,SAAS,YAAY,CAAC,GAAG,EAAE;AAC3B,EAAE,IAAI,YAAY,GAAG,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,eAAe,CAAC,CAAC;AACtD,EAAE,IAAI,YAAY,EAAE;AACpB,IAAI,YAAY,GAAG,YAAY,CAAC,OAAO,CAAC,MAAM,EAAE,EAAE,CAAC,CAAC;AACpD,IAAI,KAAK,EAAE,CAAC;AACZ,GAAG;AACH,CAAC;AACI,MAAC,IAAI,GAAG,QAAQ,CAAC,WAAW,EAAE,EAAE;AACrC,IAAI,CAAC,SAAS,CAAC,CAAC,KAAK,KAAK;AAC1B,CAAC,CAAC,CAAC;AACH,SAAS,WAAW,GAAG;AACvB,EAAE,OAAO,EAAE,CAAC;AACZ,CAAC;AACI,MAAC,UAAU,GAAG,OAAO,CAAC,IAAI,EAAE,CAAC,KAAK,KAAK;AAC5C,EAAE,MAAM,cAAc,GAAG,KAAK,EAAE,UAAU,IAAI,EAAE,CAAC;AACjD,EAAE,IAAI,cAAc,CAAC,MAAM,KAAK,CAAC,EAAE;AACnC,IAAI,OAAO,MAAM,CAAC,MAAM,CAAC,CAAC,KAAK,KAAK,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC;AACtD,GAAG;AACH,EAAE,SAAS,aAAa,CAAC,SAAS,EAAE;AACpC,IAAI,OAAO,SAAS,CAAC,MAAM,CAAC,CAAC,KAAK,KAAK,KAAK,CAAC,OAAO,GAAG,CAAC,CAAC,QAAQ,CAAC,KAAK,CAAC,OAAO,CAAC,GAAG,IAAI,CAAC,CAAC,GAAG;AAC5F,MAAM,CAAC,KAAK,KAAK,KAAK,CAAC,QAAQ,GAAG,EAAE,GAAG,KAAK,EAAE,QAAQ,EAAE,aAAa,CAAC,KAAK,CAAC,QAAQ,CAAC,EAAE,GAAG,KAAK;AAC/F,KAAK,CAAC;AACN,GAAG;AACH,EAAE,MAAM,QAAQ,GAAG,aAAa,CAAC,MAAM,CAAC,CAAC;AACzC,EAAE,IAAI,cAAc,CAAC,QAAQ,CAAC,iBAAiB,CAAC,KAAK,CAAC,EAAE;AACxD,IAAI,OAAO,QAAQ,CAAC;AACpB,GAAG;AACH,EAAE,SAAS,aAAa,CAAC,SAAS,EAAE;AACpC,IAAI,OAAO,SAAS,CAAC,MAAM;AAC3B,MAAM,CAAC,KAAK,KAAK,KAAK,CAAC,SAAS,GAAG,KAAK,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC,IAAI,KAAK,cAAc,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,GAAG,IAAI;AACvG,KAAK,CAAC,GAAG;AACT,MAAM,CAAC,KAAK,KAAK,KAAK,CAAC,QAAQ,GAAG,EAAE,GAAG,KAAK,EAAE,QAAQ,EAAE,aAAa,CAAC,KAAK,CAAC,QAAQ,CAAC,EAAE,GAAG,KAAK;AAC/F,KAAK,CAAC;AACN,GAAG;AACH,EAAE,OAAO,aAAa,CAAC,QAAQ,CAAC,CAAC;AACjC,CAAC,EAAE;AACH,eAAe,OAAO,CAAC,KAAK,EAAE,QAAQ,GAAG,KAAK,EAAE;AAChD,EAAE;AACF,IAAI,MAAM,GAAG,GAAG,MAAM,GAAG,CAAC,CAAC,aAAa,EAAE,QAAQ,GAAG,WAAW,GAAG,EAAE,CAAC,CAAC,CAAC,CAAC;AACzE,IAAI,IAAI,GAAG,CAAC,UAAU,IAAI,GAAG,CAAC,KAAK,EAAE;AACrC,MAAM,KAAK,MAAM,SAAS,IAAI,GAAG,CAAC,UAAU,EAAE;AAC9C,QAAQ,IAAI,SAAS,CAAC,QAAQ,CAAC,aAAa,CAAC,YAAY,CAAC,EAAE;AAC5D,UAAU,GAAG,CAAC,UAAU,CAAC,IAAI,CAAC,aAAa,CAAC,iBAAiB,CAAC,CAAC;AAC/D,UAAU,MAAM;AAChB,SAAS;AACT,OAAO;AACP,KAAK;AACL,IAAI,IAAI,CAAC,GAAG,CAAC,EAAE,GAAG,eAAe,CAAC,IAAI,CAAC,EAAE,GAAG,GAAG,EAAE,CAAC,CAAC;AACnD,GAAG;AACH,CAAC;AACD,eAAe,KAAK,CAAC,KAAK,EAAE;AAC5B,CAAC;AACD,eAAe,MAAM,CAAC,YAAY,EAAE,QAAQ,GAAG,KAAK,EAAE;AACtD,EAAE;AACF,IAAI,YAAY,CAAC,QAAQ,CAAC,CAAC;AAC3B,GAAG;AACH,CAAC;AACD,SAAS,YAAY,CAAC,QAAQ,EAAE;AAChC,EAAE,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;AACf,EAAE,IAAI,QAAQ,EAAE;AAChB,IAAI,IAAI,CAAC,CAAC,kBAAkB,EAAE,kBAAkB,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC;AACxF,GAAG,MAAM;AACT,IAAI,IAAI,EAAE,CAAC;AACX,GAAG;AACH,CAAC;AACD,SAAS,kBAAkB,CAAC,KAAK,EAAE;AACnC,EAAE,IAAI,CAAC,KAAK,EAAE;AACd,IAAI,MAAM,IAAI,KAAK,CAAC,oBAAoB,CAAC,CAAC;AAC1C,GAAG;AACH,EAAE,IAAI;AACN,IAAI,OAAO,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,GAAG,GAAG,CAAC;AAC3D,GAAG,CAAC,OAAO,MAAM,EAAE;AACnB,IAAI,MAAM,IAAI,KAAK,CAAC,uBAAuB,GAAG,MAAM,CAAC,CAAC;AACtD,GAAG;AACH,CAAC;AACD,SAAS,wBAAwB,CAAC,KAAK,EAAE;AACzC,EAAE,IAAI;AACN,IAAI,OAAO,IAAI,IAAI,CAAC,kBAAkB,CAAC,KAAK,CAAC,CAAC,CAAC;AAC/C,GAAG,CAAC,OAAO,MAAM,EAAE;AACnB,IAAI,OAAO,CAAC,KAAK,CAAC,0CAA0C,GAAG,MAAM,CAAC,CAAC;AACvE,IAAI,OAAO,KAAK,CAAC,CAAC;AAClB,GAAG;AACH;;;;"}