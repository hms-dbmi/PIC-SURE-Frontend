{"version":3,"file":"QueryBuilder-CR1dpoOC.js","sources":["../../../.svelte-kit/adapter-node/chunks/QueryBuilder.js"],"sourcesContent":["import { r as resources } from \"./configuration.js\";\nimport { g as get_store_value } from \"./lifecycle.js\";\nimport { u as user } from \"./User.js\";\nimport { f as filters, h as hasGenomicFilter } from \"./Filter.js\";\nclass Query {\n  categoryFilters;\n  numericFilters;\n  requiredFields;\n  anyRecordOf;\n  fields;\n  crossCountFields;\n  variantInfoFilters;\n  expectedResultType;\n  constructor(newQuery) {\n    this.categoryFilters = newQuery?.categoryFilters || {};\n    this.numericFilters = newQuery?.numericFilters || {};\n    this.requiredFields = newQuery?.requiredFields || [];\n    this.anyRecordOf = newQuery?.anyRecordOf || [];\n    this.crossCountFields = newQuery?.crossCountFields || void 0;\n    this.fields = newQuery?.fields || [];\n    const variantInfoFilter = newQuery?.variantInfoFilters?.[0] || {\n      categoryVariantInfoFilters: {},\n      numericVariantInfoFilters: {}\n    };\n    this.variantInfoFilters = [variantInfoFilter];\n    this.expectedResultType = newQuery?.expectedResultType || \"COUNT\";\n  }\n  addCategoryFilter(key, value) {\n    this.categoryFilters[key] = value;\n  }\n  removeCategoryFilter(key) {\n    delete this.categoryFilters[key];\n  }\n  addNumericFilter(key, min, max) {\n    this.numericFilters[key] = {\n      min: min.toString(),\n      max: max.toString()\n    };\n  }\n  addCategoryVariantInfoFilters(filter) {\n    this.variantInfoFilters[0].categoryVariantInfoFilters = {\n      Gene_with_variant: filter.Gene_with_variant,\n      Variant_consequence_calculated: filter.Variant_consequence_calculated,\n      Variant_frequency_as_text: filter.Variant_frequency_as_text\n    };\n  }\n  setCrossCountFields(fields) {\n    this.crossCountFields = fields;\n  }\n  addSnpFilter(snps) {\n    snps.forEach((snp) => {\n      {\n        this.categoryFilters[snp.search] = snp.constraint.split(\",\");\n      }\n    });\n  }\n  addRequiredField(field) {\n    this.requiredFields.push(field);\n  }\n  addAnyRecordOf(field) {\n    this.anyRecordOf.push(field);\n  }\n  hasFilter() {\n    const Gene_with_variant = this.variantInfoFilters[0]?.categoryVariantInfoFilters?.Gene_with_variant?.length || 0;\n    const Variant_consequence_calculated = this.variantInfoFilters[0]?.categoryVariantInfoFilters?.Variant_consequence_calculated?.length || 0;\n    const Variant_frequency_as_text = this.variantInfoFilters[0]?.categoryVariantInfoFilters?.Variant_frequency_as_text?.length || 0;\n    return Object.keys(this.categoryFilters).length + Object.keys(this.numericFilters).length + Gene_with_variant + Variant_consequence_calculated + Variant_frequency_as_text + this.requiredFields.length + this.anyRecordOf.length;\n  }\n}\nconst harmonizedPath = \"\\\\DCC Harmonized data set\";\nconst harmonizedConsentPath = \"\\\\_harmonized_consent\\\\\";\nconst topmedConsentPath = \"\\\\_topmed_consents\\\\\";\nfunction getQueryRequest(addConsents = true, resourceUUID = resources.hpds, expectedResultType = \"COUNT\") {\n  let query = new Query();\n  if (addConsents) {\n    const queryTemplate = get_store_value(user).queryTemplate;\n    if (queryTemplate) {\n      query = new Query(structuredClone(queryTemplate));\n    }\n  }\n  get_store_value(filters).forEach((filter) => {\n    if (filter.filterType === \"Categorical\") {\n      if (filter.displayType === \"restrict\") {\n        query.addCategoryFilter(filter.id, filter.categoryValues);\n      } else {\n        query.addRequiredField(filter.id);\n      }\n    } else if (filter.filterType === \"numeric\") {\n      query.addNumericFilter(filter.id, filter.min || \"\", filter.max || \"\");\n    } else if (filter.filterType === \"genomic\") {\n      query.addCategoryVariantInfoFilters({\n        Gene_with_variant: filter.Gene_with_variant,\n        Variant_consequence_calculated: filter.Variant_consequence_calculated,\n        Variant_frequency_as_text: filter.Variant_frequency_as_text\n      });\n    } else if (filter.filterType === \"snp\") {\n      query.addSnpFilter(filter.snpValues);\n    }\n  });\n  if (addConsents) {\n    query = updateConsentFilters(query);\n  }\n  query.expectedResultType = expectedResultType;\n  return {\n    query,\n    resourceUUID\n  };\n}\nfunction getBlankQueryRequest(addConsents = true, resourceUUID = resources.hpds, expectedResultType = \"COUNT\") {\n  let query = new Query();\n  if (addConsents) {\n    const queryTemplate = get_store_value(user).queryTemplate;\n    if (queryTemplate) {\n      query = new Query(structuredClone(queryTemplate));\n    }\n  }\n  if (addConsents) {\n    query = updateConsentFilters(query);\n  }\n  query.expectedResultType = expectedResultType;\n  return {\n    query,\n    resourceUUID\n  };\n}\nconst updateConsentFilters = (query) => {\n  if (!hasHarmonizedPath(query.categoryFilters) && !hasHarmonizedPath(query.numericFilters) && !fieldsIncludeHarmonizedPath(query.fields) && !fieldsIncludeHarmonizedPath(query.requiredFields)) {\n    query.removeCategoryFilter(harmonizedConsentPath);\n  }\n  if (!get_store_value(hasGenomicFilter)) {\n    query.removeCategoryFilter(topmedConsentPath);\n  }\n  return query;\n};\nconst hasHarmonizedPath = (obj) => {\n  return Object.keys(obj).some((concept) => concept.includes(harmonizedPath));\n};\nconst fieldsIncludeHarmonizedPath = (arr) => {\n  return arr.some((concept) => concept.includes(harmonizedPath));\n};\nexport {\n  getQueryRequest as a,\n  getBlankQueryRequest as g\n};\n"],"names":[],"mappings":"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"}